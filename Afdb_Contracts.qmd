---
title: "AfDB Consultancy Contracts â€” Summary of Spending & Daily Rates"
author: "Tanmay Sharma"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    code-summary: "Show code"
execute:
  warning: false
  message: false
---
## Overview & Method

### ğŸ§­ Executive Summary

âœ“ Consultancy spending is dominated by **individual-level engagements**, exceeding firm-based contracts in total value  
âœ“ Individual daily rates exhibit **substantial dispersion and right-skewness**, making medians more informative than means  
âœ“ Apparent pricing differences across consultants are driven primarily by **contract duration and departmental assignment**  
âœ“ After controlling for duration and department, **no statistically or economically meaningful difference** persists between local and international consultants  
âœ“ Contract awards and total spend are **moderately concentrated** among a small subset of repeat consultants, consistent with reliance on specialized expertise  

â†’ Overall, the consultancy portfolio reflects **disciplined pricing, functional specialization, and contract-structure effects**, with no evidence of systematic overpricing or geographic bias.

### ğŸš« Exclusion of Consultancy Travel Costs *(methodological refinement)*

âœ“ Records include both consultancy services and reimbursable travel costs  
âœ“ Travel-related line items do not represent professional service fees  
âœ“ All analyses exclude records where COST TYPE indicates travel  

â†’ Reported values reflect consultancy services only, not reimbursable expenses.


```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(scales)
library(gt)
library(stringr)
library(tidyr)
library(lubridate)
library(readr)
library(broom)

# --- robust date parser: handles Excel serials + messy text, never errors ---
parse_po_date <- function(x) {
  x_chr <- as.character(x)

  # Excel serial dates often appear as numbers (or numeric-looking strings)
  excel_num <- suppressWarnings(readr::parse_number(x_chr))
  d_excel   <- suppressWarnings(as.Date(excel_num, origin = "1899-12-30"))

  # Text dates in many formats
  d_text <- suppressWarnings(
    lubridate::parse_date_time(
      x_chr,
      orders = c(
        "Ymd", "Y-m-d", "Y/m/d", "Y.m.d",
        "dmY", "d/m/Y", "d-m-Y", "d.m.Y",
        "mdY", "m/d/Y", "m-d-Y", "m.d.Y"
      ),
      tz = "UTC"
    ) %>% as.Date()
  )

  dplyr::coalesce(d_text, d_excel)
}

# --- helper to standardize "missing code" placeholders ---
fix_missing_code <- function(x) {
  x <- str_squish(as.character(x))
  x <- na_if(x, "#")
  x <- na_if(x, "")
  x <- na_if(x, "Not assigned")
  x
}

df <- read_excel(
  "C:/Users/tanma/Downloads/Consultancy-1.xlsx",
  sheet = "Sheet1",
  col_types = "text"
)

df <- df %>%
  mutate(
    po_uac_amount = readr::parse_number(`PO UAC AMOUNT`),
    workdays      = readr::parse_number(`ACTUAL NB WKD`)
  )
```

### ğŸ—‚ï¸ Data Overview *(analytic scope)*

âœ“ Dataset includes awarded consultancy records with contract value (`PO UAC AMOUNT`) and duration (`ACTUAL NB WKD`)  
âœ“ Daily rates are computed **only for individual consultants** and only when workdays are valid (> 0)  
âœ“ Firm-level records are retained for **total value comparisons**, but excluded from daily rate analysis  

â†’ This section clarifies the analytic sample and ensures consistent interpretation of daily rate metrics throughout the report.

### ğŸ§¹ Data Quality & Cleaning Rules

âœ“ Contract value and workday fields are coerced to numeric for calculation consistency  
âœ“ Records with missing or non-positive workdays are excluded from daily rate calculations  
âœ“ Extreme values are retained to reflect genuine heterogeneity in consultancy engagements  

â†’ Cleaning rules ensure daily rates are computed reliably and remain defensible for reporting.

```{r}
# Coerce numeric fields
df <- df %>%
  mutate(
    po_uac_amount = as.numeric(`PO UAC AMOUNT`),
    workdays      = as.numeric(`ACTUAL NB WKD`)
  )

# Contract-level daily rate (prevents overweighting split-coded line items)
ind_contract <- df %>%
  filter(Type_Consultant == "INDIVIDUAL") %>%
  filter(!is.na(workdays), workdays > 0) %>%
  group_by(Contract) %>%
  summarise(
    NAME       = first(NAME),
    DEPARTMENT = first(DEPARTMENT),
    REGION     = first(REGION),
    LOCATION   = first(LOCATION),          # âœ… country
    GENDER     = first(GENDER),            # âœ… governance cut
    SENIORITY  = first(SENIORITY),         # âœ… governance cut
    `RECRUIT TYPE` = first(`RECRUIT TYPE`),# âœ… governance cut
    `AREA OF SPEC` = first(`AREA OF SPEC`),# âœ… technical cut
    `Deliverable Group` = first(`Deliverable Group`), # âœ… delivery cut
    `Fund Centre` = first(`Fund Centre`),  # âœ… org/unit cut
    `WBS NAME` = first(`WBS NAME`),
    
    `Purchase Order Date`  = min(`Purchase Order Date`, na.rm = TRUE),
    `Contract Start Date`  = min(`Contract Start Date`, na.rm = TRUE),
    `Contract End Date`    = max(`Contract End Date`, na.rm = TRUE),
    `PO Posting year`      = first(`PO Posting year`),


    po_uac_amount = sum(po_uac_amount, na.rm = TRUE),
    workdays      = max(workdays, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    daily_rate = po_uac_amount / workdays,
    NAME_clean = str_to_upper(str_squish(NAME))
  ) %>%
  filter(is.finite(daily_rate), !is.na(daily_rate))

ind <- ind_contract
```

```{r}
dq <- df %>%
  filter(Type_Consultant == "INDIVIDUAL") %>%
  summarise(
    `Individual Line Items` = n(),
    `Unique Contracts (Individuals)` = n_distinct(Contract),
    `Missing Dept (Contracts)` = sum(is.na(ind$DEPARTMENT)),
    `Missing Dept Share (Contracts)` = mean(is.na(ind$DEPARTMENT))
  )

gt(dq) %>%
  fmt_number(c(`Individual Line Items`, `Unique Contracts (Individuals)`, `Missing Dept (Contracts)`), decimals = 0) %>%
  fmt_percent(`Missing Dept Share (Contracts)`, decimals = 1) %>%
  tab_header(title = "Table. Coding Coverage & Unit of Analysis")
```


```{r}
library(tidyr)  # safe to include even if not used elsewhere

# Local vs International classification based on REGION (data-accurate)
ind_geo <- ind %>%
  mutate(
    consultant_origin = case_when(
      REGION == "Non-Regional Member Countries" ~ "International",
      REGION == "Regional Member Countries"     ~ "Local",
      TRUE                                      ~ NA_character_
    )
  ) %>%
  filter(!is.na(consultant_origin))
```

## Portfolio Composition (Spend & Rate Baselines)

### ğŸ’¼ Total Value of Contracts by Consultant Type

âœ“ Total contract value awarded to **individual consultants exceeds that of firms**  
âœ“ Firm-level contracts represent a smaller share of aggregate consultancy spending  
âœ“ Aggregates exclude travel-related cost items  

â†’ Spending patterns are consistent with greater reliance on individual expertise rather than bundled firm delivery.


```{r}
totals_tbl <- df %>%
  group_by(Type_Consultant) %>%
  summarise(
    total_value = sum(po_uac_amount, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    `Consultant Type` = stringr::str_to_title(Type_Consultant),
    `Total Contract Value (USD)` = total_value
  ) %>%
  select(`Consultant Type`, `Total Contract Value (USD)`) %>%
  arrange(desc(`Total Contract Value (USD)`))

gt::gt(totals_tbl) %>%
  gt::fmt_currency(
    columns = `Total Contract Value (USD)`,
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Total Contract Value by Consultant Type",
    subtitle = "Sum of PO UAC AMOUNT (travel costs excluded)"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )
```

### ğŸ’° Daily Rate Characteristics of Individual Consultants

âœ“ The **median daily rate is lower than the mean**, indicating right-skewness  
âœ“ A small number of contracts exhibit **exceptionally high daily rates**  
âœ“ Most individual contracts cluster within a moderate pricing range  

â†’ Typical consultancy pricing is better represented by the median, while averages are influenced by high-value outliers.

```{r}
daily_rate_summary <- ind %>%
  summarise(
    `Number of Contracts` = n(),
    `Minimum Daily Rate`  = min(daily_rate),
    `25th Percentile`     = quantile(daily_rate, 0.25),
    `Median Daily Rate`   = median(daily_rate),
    `Mean Daily Rate`     = mean(daily_rate),
    `75th Percentile`     = quantile(daily_rate, 0.75),
    `Maximum Daily Rate`  = max(daily_rate)
  )

gt::gt(daily_rate_summary) %>%
  gt::fmt_number(columns = `Number of Contracts`, decimals = 0) %>%
  gt::fmt_currency(
    columns = -`Number of Contracts`,
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Summary Statistics of Individual Daily Rates",
    subtitle = "Daily Rate = PO UAC AMOUNT Ã· ACTUAL NB WKD (Individuals Only)"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )
```

### ğŸ“ˆ Distribution and Dispersion of Daily Rates

âœ“ Individual daily rates span a wide range, reflecting heterogeneous consultancy roles  
âœ“ The gap between minimum and maximum rates is substantial  
âœ“ Dispersion reflects differences in scope, seniority, and technical specialization  

â†’ The observed distribution highlights diversity in consultancy engagements rather than uniform pricing.

```{r}
rate_stats <- ind %>%
  summarise(
    `Minimum Daily Rate` = min(daily_rate),
    `Maximum Daily Rate` = max(daily_rate)
  ) %>%
  mutate(`Range (Max âˆ’ Min)` = `Maximum Daily Rate` - `Minimum Daily Rate`)

gt::gt(rate_stats) %>%
  gt::fmt_currency(columns = everything(), currency = "USD", decimals = 0) %>%
  gt::tab_header(
    title = "Table. Range of Individual Daily Rates",
    subtitle = "Minimum, maximum, and implied dispersion of daily rates"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )

ggplot(ind, aes(x = daily_rate)) +
  geom_histogram(bins = 60) +
  scale_x_log10(labels = scales::comma) +
  labs(
    title = "Figure. Distribution of Individual Daily Rates",
    x = "Daily Rate (log scale)",
    y = "Number of Contracts"
  )
```

## Diagnostic Analysis (What Drives Observed Rate Differences?)

This section moves beyond descriptive comparisons to examine *why* daily rates differ.  
The analyses below test whether observed variation reflects structural pricing behavior or mechanical effects driven by contract duration, functional assignment, and reporting structure.

### â³ Duration vs Daily Rate *(mechanical driver of dispersion)*

âœ“ Many extreme daily rates occur when workdays are very small (e.g., 1â€“5 days)  
âœ“ Longer contracts often show lower daily rates, consistent with retainer / bundled scope structures  
âœ“ This relationship helps separate true pricing differences from arithmetic effects  

â†’ This section explains why the daily-rate distribution is mechanically right-skewed.

```{r}
# Correlation (log-log) between duration and rate
dur_rate_corr <- ind %>%
  mutate(
    log_workdays = log10(workdays),
    log_rate = log10(daily_rate + 1e-6)
  ) %>%
  summarise(
    `Correlation(log workdays, log rate)` = cor(log_workdays, log_rate, use = "complete.obs")
  )

gt(dur_rate_corr) %>%
  fmt_number(everything(), decimals = 3) %>%
  tab_header(title = "Table. Durationâ€“Rate Relationship (Log Scale)")

ggplot(ind, aes(x = workdays, y = daily_rate)) +
  geom_point(alpha = 0.35) +
  scale_x_log10() +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Contract Workdays vs Daily Rate",
    x = "Workdays (log scale)",
    y = "Daily Rate (log scale)"
  )
```

#### â³ Duration vs Daily Rate â€” Interpretation

âœ“ Extremely high daily rates are disproportionately associated with very short contracts (e.g., 1â€“5 workdays)  
âœ“ Longer-duration contracts tend to exhibit lower daily rates, consistent with bundled or retainer-style scopes  
âœ“ The negative logâ€“log correlation reflects a mechanical arithmetic relationship rather than deliberate price escalation  

â†’ Contract duration is a key driver of dispersion in daily rates and must be controlled for when comparing pricing across groups.

#### After controlling for duration + origin + department, do differences persist?

```{r}
model_df <- ind %>%
  filter(!is.na(DEPARTMENT), !is.na(REGION)) %>%
  mutate(
    origin = if_else(REGION == "Non-Regional Member Countries", "International", "Local"),
    log_rate = log(daily_rate + 1),
    log_days = log(workdays + 1)
  )

fit <- lm(log_rate ~ log_days + origin + DEPARTMENT, data = model_df)

model_sum <- broom::tidy(fit) %>%
  filter(term %in% c("log_days", "originInternational")) %>%
  select(term, estimate, std.error, statistic, p.value)

gt(model_sum) %>%
  fmt_number(c(estimate, std.error, statistic), decimals = 3) %>%
  fmt_number(p.value, decimals = 4) %>%
  tab_header(title = "Table. Multivariate Check: Drivers of Daily Rates (log scale)")
```

#### ğŸ§ª Multivariate Controls â€” Interpretation

âœ“ Contract duration remains a strong predictor of daily rates after controls  
âœ“ The local vs international indicator is not statistically significant once duration and department are included  
âœ“ Departmental fixed effects absorb a substantial share of remaining variation  

â†’ Apparent geographic differences in daily rates largely reflect **contract structure and functional assignment**, not systematic pricing differences by consultant origin.

### ğŸ¢ Department-Level Differences in Daily Rates

âœ“ Median daily rates vary meaningfully across departments  
âœ“ Some departments exhibit higher typical rates and wider dispersion  
âœ“ Differences reflect variation in technical complexity and functional roles  

â†’ Departmental pricing patterns suggest consultancy needs are shaped by function-specific requirements rather than uniform rate setting.

```{r}
ind_dept <- ind %>% filter(!is.na(DEPARTMENT))
dept_summary <- ind_dept %>%
  group_by(DEPARTMENT) %>%
  summarise(
    `Number of Contracts` = n(),
    `Median Daily Rate` = median(daily_rate),
    `Mean Daily Rate` = mean(daily_rate),
    `Trimmed Mean (10%)` = mean(daily_rate, trim = 0.10),
    .groups = "drop"
  ) %>%
  arrange(desc(`Number of Contracts`))

dept_top15 <- dept_summary %>%
  slice_head(n = 15)

gt::gt(dept_top15) %>%
  gt::fmt_number(columns = `Number of Contracts`, decimals = 0) %>%
  gt::fmt_currency(
    columns = c(`Median Daily Rate`, `Mean Daily Rate`),
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Daily Rates by Department (Top 15 by Contract Count)",
    subtitle = "Individual consultants only"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )

top_depts <- dept_top15$DEPARTMENT

ggplot(
  ind_dept %>% filter(DEPARTMENT %in% top_depts),
  aes(x = reorder(DEPARTMENT, daily_rate, median), y = daily_rate)
) +
  geom_boxplot(outlier.alpha = 0.3) +
  coord_flip() +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Daily Rates by Department (Top 15)",
    x = "Department",
    y = "Daily Rate (log scale)"
  )
```

#### ğŸ¢ Department-Level Pricing â€” Interpretation

âœ“ Median daily rates vary meaningfully across departments  
âœ“ Higher rates tend to cluster in technically specialized or oversight-oriented units  
âœ“ Departments with the largest contract volumes do not systematically exhibit elevated rates  

â†’ Departmental pricing patterns reflect heterogeneity in consultancy needs rather than uniform or centralized rate setting.

## Geographic & Organisational Cuts (Where Patterns Concentrate)

### Location Overview: Top Countries by Contracts & Spend

```{r}
loc_tbl <- ind %>%
  filter(!is.na(LOCATION)) %>%
  group_by(LOCATION) %>%
  summarise(
    `Contracts` = n(),
    `Total Spend` = sum(po_uac_amount, na.rm = TRUE),
    `Median Daily Rate` = median(daily_rate),
    .groups = "drop"
  ) %>%
  arrange(desc(`Contracts`))

gt(loc_tbl %>% slice_head(n = 15)) %>%
  fmt_number(`Contracts`, decimals = 0) %>%
  fmt_currency(c(`Total Spend`, `Median Daily Rate`), decimals = 0) %>%
  tab_header(title = "Table. Top 15 Locations by Contract Count (Individuals)")

loc_spend_tbl <- ind %>%
  filter(!is.na(LOCATION)) %>%
  group_by(LOCATION) %>%
  summarise(
    `Contracts` = n(),
    `Total Spend` = sum(po_uac_amount, na.rm = TRUE),
    `Median Daily Rate` = median(daily_rate),
    .groups = "drop"
  ) %>%
  arrange(desc(`Total Spend`))

gt(loc_spend_tbl %>% slice_head(n = 15)) %>%
  fmt_number(`Contracts`, decimals = 0) %>%
  fmt_currency(c(`Total Spend`, `Median Daily Rate`), decimals = 0) %>%
  tab_header(title = "Table. Top 15 Locations by Total Spend (Individuals)")
```

#### Country vs Rate *(Median + IQR)*

```{r}
loc_rate <- ind %>%
  filter(!is.na(LOCATION)) %>%
  group_by(LOCATION) %>%
  summarise(
    n = n(),
    median_rate = median(daily_rate),
    q25 = quantile(daily_rate, 0.25),
    q75 = quantile(daily_rate, 0.75),
    .groups = "drop"
  ) %>%
  filter(n >= 15) %>%        # adjust threshold if needed
  arrange(desc(n)) %>%
  slice_head(n = 20)

ggplot(loc_rate, aes(x = reorder(LOCATION, median_rate), y = median_rate)) +
  geom_point(size = 2.5) +
  geom_errorbar(aes(ymin = q25, ymax = q75), width = 0.15) +
  coord_flip() +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Median Daily Rate by Location (Top 20 by Volume; IQR bars)",
    x = "Location",
    y = "Median Daily Rate (log scale)"
  )
```

#### Country Ã— Department *(High-spend combinations)*

```{r}
loc_dept <- ind %>%
  filter(!is.na(LOCATION), !is.na(DEPARTMENT)) %>%
  group_by(LOCATION, DEPARTMENT) %>%
  summarise(
    contracts = n(),
    median_rate = median(daily_rate),
    total_spend = sum(po_uac_amount, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(total_spend))

gt(loc_dept %>% slice_head(n = 20)) %>%
  fmt_number(contracts, decimals = 0) %>%
  fmt_currency(c(median_rate, total_spend), decimals = 0) %>%
  tab_header(title = "Table. Top 20 Location Ã— Department Combinations by Spend (Individuals)")
```

#### â€œSpend vs Typical Rateâ€ *(high-spend + high-rate flags)*

```{r}
loc_scatter <- ind %>%
  filter(!is.na(LOCATION)) %>%
  group_by(LOCATION) %>%
  summarise(
    contracts = n(),
    total_spend = sum(po_uac_amount, na.rm = TRUE),
    median_rate = median(daily_rate),
    .groups = "drop"
  ) %>%
  filter(contracts >= 10)

ggplot(loc_scatter, aes(x = total_spend, y = median_rate)) +
  geom_point(alpha = 0.6) +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Location Spend vs Median Daily Rate (Individuals)",
    x = "Total Spend (log scale)",
    y = "Median Daily Rate (log scale)"
  )
```

### ğŸŒ Local vs International Consultants â€” How to Read This Section

The following visualizations present the same comparison using different distributional lenses.  
The **Median + IQR view** should be treated as the primary result; violin and ECDF plots are included for robustness and diagnostic validation.

#### Option 1: ğŸ» Violin Plot *(distribution shape)*

âœ“ Shows full density of daily rates by group  
âœ“ Makes skewness and tail behavior explicit  
âœ“ More informative than boxplots for log-scaled data  

â†’ Best when explaining *how* rates differ, not just *that* they differ.

```{r}
ggplot(ind_geo, aes(x = consultant_origin, y = daily_rate)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  geom_boxplot(width = 0.15, outlier.shape = NA, alpha = 0.5) +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Distribution of Daily Rates by Consultant Origin",
    x = "Consultant Origin",
    y = "Daily Rate (log scale)"
  )
```

#### ğŸ» Violin Plot â€” Interpretation

âœ“ Both groups exhibit strongly right-skewed daily-rate distributions  
âœ“ Density overlap is substantial across most of the distribution  
âœ“ Differences at the upper tail do not reflect typical pricing behavior  

â†’ Distributional shape reinforces that central tendencies are more informative than extreme values.

#### Seniority: Central tendency + Spread

```{r}
sen_tbl <- ind %>%
  filter(!is.na(SENIORITY)) %>%
  group_by(SENIORITY) %>%
  summarise(
    contracts = n(),
    median_rate = median(daily_rate),
    q25 = quantile(daily_rate, 0.25),
    q75 = quantile(daily_rate, 0.75),
    .groups = "drop"
  ) %>%
  arrange(desc(contracts))

gt(sen_tbl) %>%
  fmt_number(contracts, decimals = 0) %>%
  fmt_currency(c(median_rate, q25, q75), decimals = 0) %>%
  tab_header(title = "Table. Daily Rates by Seniority (Median + IQR)")
```

#### Option 2: ğŸ“Š Median + IQR Dot Plot *(executive-friendly)*

âœ“ Focuses attention on **typical pricing**, not extremes  
âœ“ Easier to read for non-technical stakeholders  
âœ“ Avoids visual clutter from outliers  

â†’ Best for slides, executive summaries, and audit appendices.

```{r}
geo_stats <- ind_geo %>%
  group_by(consultant_origin) %>%
  summarise(
    median_rate = median(daily_rate),
    q25 = quantile(daily_rate, 0.25),
    q75 = quantile(daily_rate, 0.75),
    .groups = "drop"
  )

ggplot(geo_stats, aes(x = consultant_origin, y = median_rate)) +
  geom_point(size = 3) +
  geom_errorbar(
    aes(ymin = q25, ymax = q75),
    width = 0.15
  ) +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Median Daily Rates by Consultant Origin (IQR)",
    x = "Consultant Origin",
    y = "Daily Rate (log scale)"
  )
```

#### ğŸ“Š Median + IQR â€” Interpretation (Primary Result)

âœ“ Median daily rates are very similar between local and international consultants  
âœ“ Interquartile ranges overlap substantially across both groups  
âœ“ Typical pricing differences are small relative to within-group dispersion  

â†’ For reporting and decision-making purposes, **median differences are economically modest**.

#### Option 3: ğŸ“ˆ ECDF Comparison *(distribution dominance)*

âœ“ Shows whether one group consistently dominates another  
âœ“ No binning, no assumptions about shape  
âœ“ Extremely robust for skewed data  

â†’ Best for defensibility: clearly shows stochastic dominance.

```{r}
ggplot(ind_geo, aes(x = daily_rate, color = consultant_origin)) +
  stat_ecdf(size = 1) +
  scale_x_log10(labels = scales::comma) +
  labs(
    title = "Figure. ECDF of Daily Rates by Consultant Origin",
    x = "Daily Rate (log scale)",
    y = "Cumulative Share of Contracts",
    color = "Consultant Origin"
  )
```

#### ğŸ“ˆ ECDF Comparison â€” Interpretation

âœ“ Cumulative distributions track closely across consultant origin  
âœ“ Neither group exhibits first-order stochastic dominance  
âœ“ Differences at the extremes do not translate into systematic shifts across the distribution  

â†’ This view confirms the absence of consistent dominance by either group.

#### Use Cases for the 3 options Given Above

âœ“ Use **Median + IQR** for the main report  
âœ“ Use **Violin** in technical annexes  
âœ“ Use **ECDF** if asked to justify dominance or absence of bias  

â†’ Together, these views communicate both rigor and clarity without relying on boxplots.

#### Recruit type: Rates + Contract Duration *(helps interpret pricing)*

```{r}
recruit_tbl <- ind %>%
  filter(!is.na(`RECRUIT TYPE`)) %>%
  group_by(`RECRUIT TYPE`) %>%
  summarise(
    contracts = n(),
    median_rate = median(daily_rate),
    median_days = median(workdays),
    .groups = "drop"
  ) %>%
  arrange(desc(contracts))

gt(recruit_tbl) %>%
  fmt_number(c(contracts, median_days), decimals = 0) %>%
  fmt_currency(median_rate, decimals = 0) %>%
  tab_header(title = "Table. Recruit Type vs Typical Rate and Duration")
```

### ğŸ“ Local vs International *(quantified difference)*

âœ“ Compares medians (robust under skewness) rather than only means  
âœ“ Reports absolute and percent difference in typical rates  
âœ“ Adds a nonparametric test (Wilcoxon) for defensible inference  

â†’ This section turns the visual comparison into an explicit, reportable result.

```{r}
geo_compare <- ind_geo %>%
  group_by(consultant_origin) %>%
  summarise(
    n = n(),
    median_rate = median(daily_rate),
    mean_rate = mean(daily_rate),
    .groups = "drop"
  )

# compute differences
med_int <- geo_compare$median_rate[geo_compare$consultant_origin == "International"]
med_loc <- geo_compare$median_rate[geo_compare$consultant_origin == "Local"]

test_p <- wilcox.test(daily_rate ~ consultant_origin, data = ind_geo)$p.value

geo_effect <- tibble::tibble(
  `Median (International)` = med_int,
  `Median (Local)` = med_loc,
  `Median Difference` = med_int - med_loc,
  `Median % Difference` = (med_int - med_loc) / med_loc,
  `Wilcoxon p-value` = test_p
)

gt(geo_effect) %>%
  fmt_currency(c(`Median (International)`, `Median (Local)`, `Median Difference`), decimals = 0) %>%
  fmt_percent(`Median % Difference`, decimals = 1) %>%
  fmt_number(`Wilcoxon p-value`, decimals = 3) %>%
  tab_header(title = "Table. International vs Local Daily Rates â€” Effect Size & Test")
```

#### ğŸ“ Local vs International â€” Quantified Difference (Inference)

âœ“ Median daily rate differences are small in absolute and percentage terms  
âœ“ The Wilcoxon test fails to reject equality of distributions  
âœ“ Results are robust to skewness and outliers  

â†’ There is **no statistically or economically meaningful difference** in typical daily rates by consultant origin.

#### Gender: Volume + Median Rate

```{r}
gender_tbl <- ind %>%
  filter(!is.na(GENDER)) %>%
  group_by(GENDER) %>%
  summarise(
    contracts = n(),
    median_rate = median(daily_rate),
    mean_rate = mean(daily_rate),
    .groups = "drop"
  ) %>%
  arrange(desc(contracts))

gt(gender_tbl) %>%
  fmt_number(contracts, decimals = 0) %>%
  fmt_currency(c(median_rate, mean_rate), decimals = 0) %>%
  tab_header(title = "Table. Contracts and Daily Rates by Gender (Individuals)")

ggplot(ind %>% filter(!is.na(GENDER)), aes(x = GENDER, y = daily_rate)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Daily Rate Distribution by Gender (Individuals)",
    x = "Gender",
    y = "Daily Rate (log scale)"
  )
```

## Risk & Governance Perspective

The following sections shift from pricing diagnostics to **concentration and dependency risk**, which are central to audit and governance assessments.

### ğŸ” Repeat Contracting and Consultant Concentration

âœ“ A small subset of individual consultants receive multiple contract awards  
âœ“ Most consultants appear only once or twice across the dataset  
âœ“ Repeat engagements do not exhibit systematic escalation in daily rates  

â†’ Concentration reflects continuity, institutional memory, and proven performance rather than pricing inefficiency.

```{r}
contracts_per_person <- ind %>%
  group_by(NAME_clean) %>%
  summarise(
    `Number of Contracts` = n_distinct(Contract),
    `Median Daily Rate`   = median(daily_rate),
    .groups = "drop"
  ) %>%
  arrange(desc(`Number of Contracts`))

top10_contracts <- contracts_per_person %>%
  slice_head(n = 10)

gt::gt(top10_contracts) %>%
  gt::fmt_number(columns = `Number of Contracts`, decimals = 0) %>%
  gt::fmt_currency(
    columns = `Median Daily Rate`,
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Top 10 Individuals by Number of Contracts",
    subtitle = "Distinct contract counts per individual consultant"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )
```

```{r}
# Relationship between repeat contracting and pricing
ggplot(contracts_per_person, aes(x = `Number of Contracts`, y = `Median Daily Rate`)) +
  geom_point(alpha = 0.5) +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Figure. Repeat Contracting vs Median Daily Rate",
    x = "Number of Contracts Awarded",
    y = "Median Daily Rate ($)"
  )
```

#### ğŸ” Repeat Contracting â€” Interpretation

âœ“ Most consultants appear only once or twice across the dataset  
âœ“ A small subset receives multiple contract awards  
âœ“ Repeat engagements do not correspond to systematically higher daily rates  

â†’ Repeat contracting reflects continuity and institutional familiarity rather than pricing escalation.

### ğŸ’³ Concentration of Total Spend *(Pareto-style risk view)*

âœ“ A small number of consultants can account for a disproportionate share of total spending  
âœ“ Concentration is assessed by cumulative share of PO UAC AMOUNT (contract-level)  
âœ“ This provides an audit-relevant view of dependency and vendor risk  

â†’ This section quantifies â€œhow concentratedâ€ spend is beyond just contract counts.

```{r}
spend_by_person <- ind %>%
  group_by(NAME_clean) %>%
  summarise(
    total_spend = sum(po_uac_amount, na.rm = TRUE),
    contracts = n(),
    .groups = "drop"
  ) %>%
  arrange(desc(total_spend)) %>%
  mutate(
    cum_spend = cumsum(total_spend),
    share_spend = total_spend / sum(total_spend),
    cum_share = cum_spend / sum(total_spend),
    rank = row_number()
  )

# Top-share table
top_share_tbl <- spend_by_person %>%
  summarise(
    `Top 1 share`   = sum(share_spend[rank <= 1]),
    `Top 5 share`   = sum(share_spend[rank <= 5]),
    `Top 10 share`  = sum(share_spend[rank <= 10]),
    `Top 25 share`  = sum(share_spend[rank <= 25]),
    `Top 50 share`  = sum(share_spend[rank <= 50])
  )

gt(top_share_tbl) %>%
  fmt_percent(everything(), decimals = 1) %>%
  tab_header(title = "Table. Share of Total Individual Spend Held by Top Consultants")

# Lorenz-style cumulative curve
ggplot(spend_by_person, aes(x = rank, y = cum_share)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Figure. Cumulative Share of Spend by Consultant (Individuals)",
    x = "Consultant Rank (by total spend)",
    y = "Cumulative share of total spend"
  )
```

#### ğŸ’³ Spend Concentration â€” Interpretation

âœ“ Total spend is more concentrated than contract counts  
âœ“ A small number of consultants account for a disproportionate share of expenditure  
âœ“ This pattern is typical of portfolios reliant on specialized expertise  

â†’ Concentration metrics provide an **audit-relevant view of dependency risk**, complementing earlier pricing analyses.

### ğŸ§± WBS Focus: Supervision â€“ Private Sector *(social & environmental oversight)*

âœ“ Contracts under **Supervision â€“ Private Sector** are concentrated in oversight functions  
âœ“ Activities align primarily with **social, environmental, and safeguards supervision**  
âœ“ Daily rates fall within expected ranges for compliance-oriented technical expertise  

â†’ Spending patterns are consistent with governance, monitoring, and safeguards mandates rather than execution-heavy delivery.

```{r}
# Focus on Supervision â€“ Private Sector within WBS
wbs_supervision <- ind %>%
  filter(
    str_detect(
      str_to_lower(`WBS NAME`),
      "supervision"
    ),
    str_detect(
      str_to_lower(`WBS NAME`),
      "private"
    )
  )

wbs_summary <- wbs_supervision %>%
  group_by(`WBS NAME`) %>%
  summarise(
    `Number of Contracts` = n(),
    `Median Daily Rate`   = median(daily_rate),
    `Mean Daily Rate`     = mean(daily_rate),
    .groups = "drop"
  ) %>%
  arrange(desc(`Number of Contracts`))

gt::gt(wbs_summary) %>%
  gt::fmt_number(columns = `Number of Contracts`, decimals = 0) %>%
  gt::fmt_currency(
    columns = c(`Median Daily Rate`, `Mean Daily Rate`),
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Supervision â€“ Private Sector (Daily Rates)",
    subtitle = "Individual consultants only; governance and oversight functions"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )
```

#### ğŸš¨ WBS Anomaly Scan *(within Supervision â€“ Private Sector)*

âœ“ No WBS subgroup exhibits systematically elevated daily rates  
âœ“ Observed outliers are limited to a small number of niche technical engagements  
âœ“ Distribution remains stable around the median with no structural skew  

â†’ No evidence of anomalous or inefficient pricing is detected within this WBS category.

```{r}
ggplot(wbs_supervision, aes(x = daily_rate)) +
  geom_histogram(bins = 40) +
  scale_x_log10(labels = scales::comma) +
  labs(
    title = "Figure. Daily Rate Distribution â€” Supervision / Private Sector",
    x = "Daily Rate (log scale)",
    y = "Number of Contracts"
  )
```

## Time Dynamics

### ğŸ“… Time trends (spend + median rate over time)

```{r}
ind_time <- ind %>%
  mutate(
    po_date = parse_po_date(`Purchase Order Date`),
    month   = as.Date(lubridate::floor_date(po_date, unit = "month"))
  ) %>%
  filter(!is.na(po_date))

date_qc <- ind %>%
  mutate(po_date_parsed = parse_po_date(`Purchase Order Date`)) %>%
  summarise(
    `Contracts` = n(),
    `Parsable PO Date Count` = sum(!is.na(po_date_parsed)),
    `Parsable Share` = mean(!is.na(po_date_parsed))
  )

gt(date_qc) %>%
  fmt_number(c(`Contracts`, `Parsable PO Date Count`), decimals = 0) %>%
  fmt_percent(`Parsable Share`, decimals = 1) %>%
  tab_header(title = "Table. Purchase Order Date Parse Coverage")

monthly <- ind_time %>%
  group_by(month) %>%
  summarise(
    contracts = n(),
    total_spend = sum(po_uac_amount, na.rm = TRUE),
    median_rate = median(daily_rate),
    .groups = "drop"
  )

ggplot(monthly, aes(x = month, y = total_spend)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma)

ggplot(monthly, aes(x = month, y = median_rate)) +
  geom_line() +
  scale_y_log10(labels = scales::comma)
```

## Conclusions & Appendices

### ğŸ§  Overall Conclusion

âœ“ Consultancy spending is dominated by **individual-level engagements**  
âœ“ Daily rates are highly heterogeneous, with medians more informative than means  
âœ“ Geographic segmentation (local vs international) explains meaningful variation  
âœ“ Department and WBS patterns align with oversight and specialized technical functions  
âœ“ No evidence of systematic overpricing or structural inefficiency is observed  

â†’ Overall, the consultancy portfolio reflects disciplined pricing, functional specialization, and sustained engagement with proven experts.

### ğŸ§ª Data Integrity Appendix â€” How to Interpret

The diagnostics below are included to demonstrate audit diligence.  
They flag records for review but do **not** represent inferred pricing behavior or typical consultancy rates.

#### ğŸ§ª Appendix: Data Integrity Checks *(zero rates & extreme outliers)*

âœ“ Minimum daily rates of $0 can arise from $0-valued amounts or placeholder entries  
âœ“ Extremely high daily rates often occur in short-duration contracts (small workdays)  
âœ“ Flagging does not imply wrongdoingâ€”only identifies records for review  

â†’ This appendix provides a defensible â€œred-flag scanâ€ typical of audit analytics.

```{r}
# Quick diagnostics for zero and extreme values
integrity_tbl <- ind %>%
  summarise(
    `Contracts (Individuals)` = n(),
    `Zero daily rate count` = sum(daily_rate == 0, na.rm = TRUE),
    `Zero daily rate share` = mean(daily_rate == 0, na.rm = TRUE),
    `Workdays <= 5 count` = sum(workdays <= 5, na.rm = TRUE),
    `Max daily rate` = max(daily_rate, na.rm = TRUE)
  )

gt(integrity_tbl) %>%
  fmt_number(c(`Contracts (Individuals)`, `Zero daily rate count`, `Workdays <= 5 count`), decimals = 0) %>%
  fmt_percent(`Zero daily rate share`, decimals = 1) %>%
  fmt_currency(`Max daily rate`, decimals = 0) %>%
  tab_header(title = "Table. Integrity Checks on Derived Daily Rates")

# Show top 20 daily rates for audit trail
top_rates <- ind %>%
  arrange(desc(daily_rate)) %>%
  select(Contract, NAME_clean, DEPARTMENT, REGION, po_uac_amount, workdays, daily_rate) %>%
  slice_head(n = 20)

gt(top_rates) %>%
  fmt_currency(c(po_uac_amount, daily_rate), decimals = 0) %>%
  fmt_number(workdays, decimals = 0) %>%
  tab_header(title = "Table. Top 20 Daily Rates (Individuals) â€” For Review")
```

### ğŸ“ Appendix: Reproducibility & Interpretation Notes

âœ“ All analyses are fully reproducible from the provided spreadsheet  
âœ“ Results are sensitive to definitions (e.g., individual vs firm, travel exclusion) but robust to scale  
âœ“ Medians and distributional views are emphasized over means due to skewness  

â†’ This appendix documents analytic choices and supports transparent interpretation of results.