---
title: "mp04"
---

**Data Acquisition**

```{r}
needed_pkgs <- c(
  "tidyverse",
  "httr2",
  "rvest",
  "lubridate",
  "infer",
  "janitor"
)

to_install <- setdiff(needed_pkgs, rownames(installed.packages()))
if (length(to_install) > 0) {
  install.packages(to_install)
}

invisible(lapply(needed_pkgs, library, character.only = TRUE))
```

*Downloading CES Total Nonfarm Payroll**

```{r task1_ces_download, message=FALSE, warning=FALSE}
library(tidyverse)
library(httr2)
library(rvest)
library(lubridate)
library(janitor)

# --- 1. Build the HTTP request to the PDQ page ---

ces_base <- "https://data.bls.gov/pdq/SurveyOutputServlet"

ces_req <- request(ces_base) |>
  req_method("POST") |>
  req_body_form(
    # IMPORTANT:
    # These fields MUST match what you see in your browser's
    # Network -> Request Payload when you:
    #   - go to Data Finder top picks for CES
    #   - select "Total Nonfarm, Seasonally Adjusted"
    #   - set start year = 1979
    #
    # What I expect (you can adjust if your browser shows slightly different names):
    survey    = "ce",
    from_year = "1979",
    to_year   = "2025",
    # This is the CES series ID for All Employees, Total Nonfarm, SA
    series_id = "CES0000000001"
    # If your browser shows additional form fields (periods, output_type, etc.),
    # add them here exactly as shown.
  )

# Perform request and get HTML
ces_html <- ces_req |>
  req_perform() |>
  resp_body_html()

# --- 2. Grab the main data table from the HTML ---

ces_raw_tbl <- ces_html |>
  html_element("table") |>
  html_table(fill = TRUE) |>
  clean_names()

# Peek at the raw table structure
head(ces_raw_tbl)

all_tables <- ces_html |> html_elements("table")
length(all_tables)

all_tables[[2]] |> html_table(fill = TRUE) |> head()

# Get ALL tables from the HTML
all_tables <- ces_html |> html_elements("table")

# Extract the SECOND table, which you confirmed is the Year–Month table
ces_data_raw <- all_tables[[2]] |>
  html_table(fill = TRUE) |>
  clean_names()

# Check it
head(ces_data_raw)
```
Cleaning code from this chunk

```{r task1_ces_clean, message=FALSE, warning=FALSE}
ces_levels <- ces_data_raw |>
  clean_names() |>
  pivot_longer(
    cols = -year,
    names_to  = "month",
    values_to = "level"
  ) |>
  mutate(
    month = str_to_title(month),
    date_str = paste(year, month),
    date = lubridate::ym(date_str),
    level = as.numeric(level)
  ) |>
  drop_na(date, level) |>
  filter(date <= as.Date("2025-06-01")) |>
  arrange(date) |>
  select(date, level)

head(ces_levels)
```
**Task 2: Download CES Revision Tables**

```{r task2_fetch_html, message=FALSE, warning=FALSE}
url_rev <- "https://www.bls.gov/web/empsit/cesnaicsrev.htm"

rev_html <- request(url_rev) |>
  req_user_agent("Mozilla/5.0 (Windows NT 10.0)") |>  # Avoids 403
  req_perform() |>
  resp_body_html()

rev_html
```

```{r task2_inspect_tables, message=FALSE, warning=FALSE}
library(rvest)
library(tidyverse)
library(lubridate)

# All tables on the revisions page
rev_tables <- rev_html |> html_elements("table")

length(rev_tables)

# Look at the first few table IDs to see the pattern
head(html_attr(rev_tables, "id"), 20)
```
Fixing extraction function to use this pattern

```{r task2_extract_year_function_fixed, message=FALSE, warning=FALSE}
extract_ces_revisions_year <- function(year) {
  
  table_id <- as.character(year)
  
  tbl <- rev_html |>
    html_element(paste0("table#", table_id)) |>
    html_table(header = FALSE, fill = TRUE) |>
    janitor::clean_names()
  
  # Drop the first 3 header rows, then keep the 12 months
  tbl <- tbl |>
    slice(-(1:3)) |>
    slice(1:12) |>
    select(
      month    = 1,  # month name (Jan, Feb, ...)
      original = 3,  # first estimate
      final    = 4   # final (third) estimate
    ) |>
    mutate(
      month    = stringr::str_to_title(month),
      date_str = paste(year, month),
      date     = lubridate::ym(date_str),
      original = as.numeric(original),
      final    = as.numeric(final),
      revision = final - original
    ) |>
    select(date, original, final, revision) |>
    arrange(date)
  
  tbl
}

# Test again on 2024
extract_ces_revisions_year(2024)
```
Now building the full revisions dataset

```{r task2_build_full_revisions, message=FALSE, warning=FALSE}
library(purrr)
library(dplyr)

# All years with published revisions
years <- 1979:2025

ces_revisions <- map_dfr(years, extract_ces_revisions_year) |>
  # Only keep months through June 2025 as per instructions
  filter(date <= as.Date("2025-06-01")) |>
  arrange(date)

# Quick check
ces_revisions |> dplyr::slice_head(n = 12)
ces_revisions |> dplyr::slice_tail(n = 12)
```
Joining levels and revisions into one table

```{r task3_join_levels_revisions, message=FALSE, warning=FALSE}
library(dplyr)
library(lubridate)

ces_full <- ces_levels |>          # from Task 1
  left_join(ces_revisions, by = "date") |>
  mutate(
    year       = year(date),
    month_num  = month(date),
    month_name = month(date, label = TRUE, abbr = TRUE),
    abs_revision     = abs(revision),
    rel_revision     = revision / level,
    abs_rel_revision = abs(revision) / level
  )

ces_full |> slice_head(n = 12)
```

**Task 3: Data Exploration and Visualization**

Computing 6 statistics about CES over the past 45 years
```{r task3_stats, message=FALSE, warning=FALSE}
library(dplyr)

ces_summary <- ces_full |>
  summarise(
    n_months                 = n(),
    avg_level                = mean(level, na.rm = TRUE),
    sd_level                 = sd(level, na.rm = TRUE),
    avg_revision             = mean(revision, na.rm = TRUE),
    sd_revision              = sd(revision, na.rm = TRUE),
    avg_abs_revision         = mean(abs_revision, na.rm = TRUE),
    avg_rel_revision_pct     = mean(rel_revision, na.rm = TRUE) * 100,
    pct_negative_revisions   = mean(revision < 0, na.rm = TRUE) * 100
  )

ces_summary
```
Constructing 4 visualizations of CES estimates over the past 45 years
1st Visualization: Revisions over Time (Line Plot)
```{r task3_plot1_revisions_ts, message=FALSE, warning=FALSE}
library(ggplot2)

ggplot(ces_full, aes(date, revision)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(
    title = "CES Revisions Over Time (1979–2025)",
    subtitle = "Final minus original sector-level employment change",
    x = "Date",
    y = "Revision (thousands of jobs)"
  )
```
2nd Visualization: Absolute Revision Over Time
```{r task3_plot2_absrev_ts, message=FALSE, warning=FALSE}
ggplot(ces_full, aes(date, abs_revision)) +
  geom_line(color = "steelblue") +
  labs(
    title = "Absolute CES Revisions Over Time",
    x = "Date",
    y = "Absolute Revision (|final - original|)"
  )
```
3rd Visualization: Revisions as % of Employment Level
```{r task3_plot3_relrev_ts, message=FALSE, warning=FALSE}
ggplot(ces_full, aes(date, rel_revision * 100)) +
  geom_line(color = "firebrick") +
  labs(
    title = "Revisions Relative to Employment Level (%)",
    x = "Date",
    y = "Revision as % of Level"
  )
```
4th Visualization: Distribution of Revisions
```{r task3_plot4_revision_hist, message=FALSE, warning=FALSE}
ggplot(ces_full, aes(revision)) +
  geom_histogram(bins = 40, color = "white", fill = "darkblue") +
  labs(
    title = "Distribution of CES Revisions (1979–2025)",
    x = "Revision (thousands of jobs)",
    y = "Count"
  )
```

**Task 4: Statistical Inference**

```{r task4_setup, message=FALSE, warning=FALSE}
library(dplyr)
library(infer)
library(lubridate)

# Add all needed variables to ces_full
ces_full <- ces_full |>
  arrange(date) |>
  mutate(
    year              = year(date),
    negative_revision = revision < 0,
    post_2000         = year >= 2000,
    abs_revision      = abs(revision),
    rel_revision      = revision / level,
    abs_rel_revision  = abs(revision) / level,
    big_1pct          = abs_rel_revision > 0.01,      # >1% of level
    post_2020         = year >= 2020,
    change            = level - lag(level),
    abs_change        = abs(change)
  )
```
4.1 Has the fraction of negative revisions increased post-2000?
```{r task4_q1_prop_negative_post2000, message=FALSE, warning=FALSE}
# Count negative vs total before/after 2000
neg_tab <- ces_full |>
  filter(!is.na(negative_revision), !is.na(post_2000)) |>
  group_by(post_2000) |>
  summarise(
    neg = sum(negative_revision),
    n   = n(),
    .groups = "drop"
  )

neg_tab

# Order: FALSE = pre-2000, TRUE = post-2000
x_neg <- neg_tab$neg[order(neg_tab$post_2000)]
n_neg <- neg_tab$n[order(neg_tab$post_2000)]

prop_neg_post2000 <- prop.test(x = x_neg, n = n_neg)
prop_neg_post2000
```
4.2 Has the fraction of >1% revisions increased post-2020?
```{r task4_q2_prop_big1pct_post2020, message=FALSE, warning=FALSE}
big_tab <- ces_full |>
  filter(!is.na(big_1pct), !is.na(post_2020)) |>
  group_by(post_2020) |>
  summarise(
    big = sum(big_1pct),
    n   = n(),
    .groups = "drop"
  )

big_tab

# Order: FALSE = pre-2020, TRUE = post-2020
x_big <- big_tab$big[order(big_tab$post_2020)]
n_big <- big_tab$n[order(big_tab$post_2020)]

prop_big_post2020 <- prop.test(x = x_big, n = n_big)
prop_big_post2020
```
4.3 Is the average revision significantly different from zero?
```{r task4_q3_mean_revision_zero, message=FALSE, warning=FALSE}
# One-sample t-test using base R: H0: mean revision = 0
rev_vec <- ces_full$revision
rev_vec <- rev_vec[!is.na(rev_vec)]

ttest_mean_rev <- t.test(rev_vec, mu = 0)

ttest_mean_rev
```

4.4 Has the average revision increased post-2020?
```{r task4_q4_mean_revision_post2020, message=FALSE, warning=FALSE}
ttest_mean_rev_post2020 <- ces_full |>
  drop_na(revision, post_2020) |>
  t_test(
    revision ~ post_2020,
    order = c("FALSE", "TRUE")   # estimate = post-2020 − pre-2020
  )

ttest_mean_rev_post2020
```
4.5 Are revisions larger when the underlying change is larger?
```{r task4_q5_cor_abschange_absrevision, message=FALSE, warning=FALSE}
ces_cor <- ces_full |>
  drop_na(abs_change, abs_revision)

cor_abs <- cor.test(ces_cor$abs_change, ces_cor$abs_revision)

cor_abs
```
