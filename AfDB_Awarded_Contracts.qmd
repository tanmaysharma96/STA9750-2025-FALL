---
title: "AfDB Awarded Contracts"
author: "Tanmay Sharma"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    code-summary: "Show code"
execute:
  warning: false
  message: false
---

## 1. Data Import & Preparation

::: {.callout-note}
### üìò Introduction
This report analyzes AfDB awarded contract records (2020‚Äì2025) to understand **procurement method mix**, **domestic vs cross-border sourcing**, **supplier concentration**, and **risk screening flags**.  
We begin by importing the Excel extract, standardizing key fields, and constructing clean analytical variables (e.g., USD spend, procurement mode, domestic award indicator).
:::

```{r}
rm(list = ls())
gc()

library(readxl)
library(dplyr)
library(janitor)
library(stringr)
library(readr)
library(gt)
library(scales)

# Use the attached file path (recommended for portability)

path <- "C:/Users/tanma/Downloads/listing_of_awarded_contracts_from_2020_to_2025_-_october_2025 (3).xlsx"

raw <- read_excel(path, skip = 2)

to_num <- function(x){
if (is.numeric(x)) return(x)
readr::parse_number(as.character(x))
}

df <- raw %>%
clean_names() %>%
select(where(~ !all(is.na(.)))) %>%
mutate(
year = as.integer(year),
spend_usd = to_num(equiv_usd),
cont_uac = to_num(cont_am_uac),

project_def = str_squish(as.character(project_def)),
loan_number = str_squish(as.character(loan_number)),
bidder_name = str_squish(as.character(bidder_name)),
bidder_nationality = str_squish(as.character(bidder_nationality)),
project_country = str_squish(as.character(project_country)),
sector = str_squish(as.character(sector)),
proc_mode = str_squish(as.character(proc_mode)),
expense_category = str_squish(as.character(expense_category)),

domestic_award = (str_to_upper(bidder_nationality) == str_to_upper(project_country))

) %>%
filter(!is.na(year), !is.na(spend_usd)) %>%
filter(year >= 2020, year <= 2025)

# Polished "Data snapshot" table (no tibble printing)

df %>%
  summarise(
    rows_awards = n(),
    years_covered = paste0(min(year, na.rm = TRUE), "‚Äì", max(year, na.rm = TRUE)),
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    median_award_usd = median(spend_usd, na.rm = TRUE),
    distinct_countries = n_distinct(project_country),
    distinct_suppliers = n_distinct(bidder_name),
    distinct_sectors = n_distinct(sector),
    distinct_proc_modes = n_distinct(proc_mode)
  ) %>%
  gt() %>%
  cols_label(
    rows_awards = "Rows (awards)",
    years_covered = "Years covered",
    total_spend_usd = "Total spend (USD)",
    median_award_usd = "Median award (USD)",
    distinct_countries = "Distinct countries",
    distinct_suppliers = "Distinct suppliers",
    distinct_sectors = "Distinct sectors",
    distinct_proc_modes = "Distinct procurement modes"
  ) %>%
  fmt_number(
    columns = c(rows_awards, distinct_countries, distinct_suppliers, distinct_sectors, distinct_proc_modes),
    decimals = 0
  ) %>%
  fmt_currency(
    columns = c(total_spend_usd, median_award_usd),
    currency = "USD",
    decimals = 0
  ) %>%
  tab_header(
    title = "Data Import Snapshot",
    subtitle = "AfDB Awarded Contracts (filtered to 2020‚Äì2025)"
  )
```

## 2. Data Cleaning & Standardization

::: {.callout-note}
### üßπ Cleanup Overview
Raw procurement extracts often contain inconsistent capitalization, stray whitespace, duplicated category labels, and Excel-generated placeholder columns.  
This section standardizes key categorical fields (procurement mode, expense category, sector, country, and supplier names) to ensure that downstream grouping, aggregation, and risk screening are analytically valid and reproducible.

The cleanup process focuses on **harmonization rather than transformation**‚Äîno records are dropped, and no financial values are altered‚Äîso that all subsequent analysis reflects the original awarded-contract universe.
:::

```{r}
library(dplyr)
library(stringr)
library(gt)

# Snapshot BEFORE cleanup (for audit table)

audit_before <- df %>%
summarise(
stage = "Before cleanup",
rows_awards = n(),
missing_proc_mode = sum(is.na(proc_mode) | proc_mode == ""),
missing_expense_category = sum(is.na(expense_category) | expense_category == ""),
missing_sector = sum(is.na(sector) | sector == ""),
distinct_proc_modes = n_distinct(proc_mode),
distinct_expense_categories = n_distinct(expense_category),
distinct_sectors = n_distinct(sector)
)

# Cleanup / standardization

df_clean <- df %>%
select(-matches("^x\\d+$")) %>%  # drops x18, x19, x20 etc
mutate(
proc_mode          = str_to_upper(str_squish(proc_mode)),
expense_category   = str_to_upper(str_squish(expense_category)),
sector             = str_squish(sector),
project_country    = str_squish(project_country),
bidder_nationality = str_squish(bidder_nationality),
bidder_name        = str_squish(bidder_name),
project_def        = str_squish(project_def),
loan_number        = str_squish(loan_number)
)

# Snapshot AFTER cleanup (for audit table)

audit_after <- df_clean %>%
summarise(
stage = "After cleanup",
rows_awards = n(),
missing_proc_mode = sum(is.na(proc_mode) | proc_mode == ""),
missing_expense_category = sum(is.na(expense_category) | expense_category == ""),
missing_sector = sum(is.na(sector) | sector == ""),
distinct_proc_modes = n_distinct(proc_mode),
distinct_expense_categories = n_distinct(expense_category),
distinct_sectors = n_distinct(sector)
)

# Polished audit table (no tibble printing)

bind_rows(audit_before, audit_after) %>%
gt() %>%
cols_label(
stage = "Stage",
rows_awards = "Rows (awards)",
missing_proc_mode = "Missing procurement mode",
missing_expense_category = "Missing expense category",
missing_sector = "Missing sector",
distinct_proc_modes = "Distinct procurement modes",
distinct_expense_categories = "Distinct expense categories",
distinct_sectors = "Distinct sectors"
) %>%
fmt_number(
columns = c(
rows_awards,
missing_proc_mode, missing_expense_category, missing_sector,
distinct_proc_modes, distinct_expense_categories, distinct_sectors
),
decimals = 0
) %>%
tab_header(
title = "Cleanup Audit (Before vs After)",
subtitle = "Counts and distinct levels used for grouping"
)

# Overwrite df so downstream code remains unchanged

df <- df_clean
```

## 3. Method Mix vs Contract Value

::: {.callout-note}
### üìä Analytical Focus
Procurement methods differ not only in how frequently they are used, but also in the **value of contracts they carry**.  
This section examines the distribution of award sizes by procurement mode to assess whether higher-value contracts are systematically concentrated in particular methods.

The analysis emphasizes **value-weighted metrics and upper-tail behavior**, since governance, competition, and value-for-money risks are typically greatest for large awards rather than for small, routine contracts.
:::

### 3A. Percentile & Value Share Table (Polished Output)

```{r}
library(dplyr)
library(gt)
library(scales)

method_value_tbl <- df %>%
group_by(proc_mode) %>%
summarise(
awards = n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
usd_share = total_spend_usd / sum(spend_usd, na.rm = TRUE),
p25 = quantile(spend_usd, 0.25, na.rm = TRUE),
p50 = quantile(spend_usd, 0.50, na.rm = TRUE),
p75 = quantile(spend_usd, 0.75, na.rm = TRUE),
p90 = quantile(spend_usd, 0.90, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(total_spend_usd))

method_value_tbl %>%
gt() %>%
cols_label(
proc_mode = "Procurement mode",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
usd_share = "Share of total spend",
p25 = "P25 award (USD)",
p50 = "Median award (USD)",
p75 = "P75 award (USD)",
p90 = "P90 award (USD)"
) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_currency(
columns = c(total_spend_usd, p25, p50, p75, p90),
currency = "USD",
decimals = 0
) %>%
fmt_percent(columns = usd_share, decimals = 1) %>%
tab_header(
title = "Procurement Method Mix ‚Äî Contract Value Distribution",
subtitle = "Award percentiles and value-weighted share (2020‚Äì2025)"
)
```

**Interpretation.**  
Procurement modes vary substantially in both typical contract size (median) and upper-tail exposure (P90).  
Modes carrying a disproportionate share of total spend warrant closer scrutiny to ensure that competition intensity and procurement approach remain aligned with contract value.

### 3B. Distribution Visual (Log Scale)

```{r}
library(ggplot2)
library(scales)

ggplot(df, aes(x = proc_mode, y = spend_usd)) +
geom_violin(trim = TRUE, fill = "grey85") +
geom_boxplot(width = 0.15, outlier.alpha = 0.2) +
scale_y_log10(labels = label_dollar()) +
labs(
title = "Award Size Distribution by Procurement Mode (log scale)",
x = "Procurement mode",
y = "Award size (USD, log scale)"
)
```

## 4. Domestic vs Cross-Border Sourcing

::: {.callout-note}
### üåç Analytical Focus
Domestic sourcing is defined as cases where the **supplier nationality matches the project country**.  
This section examines how procurement spend is split between domestic and cross-border suppliers, providing insight into **local market depth**, **supplier capacity**, and **reliance on international firms**.

Results are presented at the **country**, **expense-category**, and **time-series** levels to distinguish structural patterns from short-term fluctuations.
:::

### 4A. Country-Level Domestic vs Cross-Border Share

```{r}
library(dplyr)
library(gt)
library(scales)

country_domestic_tbl <- df %>%
group_by(project_country) %>%
summarise(
awards = n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
domestic_spend_usd = sum(spend_usd[domestic_award], na.rm = TRUE),
domestic_share = domestic_spend_usd / total_spend_usd,
cross_border_share = 1 - domestic_share,
.groups = "drop"
) %>%
arrange(desc(total_spend_usd))

country_domestic_tbl %>%
gt() %>%
cols_label(
project_country = "Project country",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
domestic_spend_usd = "Domestic spend (USD)",
domestic_share = "Domestic share",
cross_border_share = "Cross-border share"
) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_currency(
columns = c(total_spend_usd, domestic_spend_usd),
currency = "USD",
decimals = 0
) %>%
fmt_percent(
columns = c(domestic_share, cross_border_share),
decimals = 1
) %>%
tab_header(
title = "Domestic vs Cross-Border Sourcing by Country",
subtitle = "Share of procurement spend by supplier nationality (2020‚Äì2025)"
)
```

### 4B. Domestic Share by Expense Category

```{r}
expense_domestic_tbl <- df %>%
group_by(expense_category) %>%
summarise(
awards = n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
domestic_share = sum(spend_usd[domestic_award], na.rm = TRUE) / sum(spend_usd),
cross_border_share = 1 - domestic_share,
.groups = "drop"
) %>%
arrange(desc(total_spend_usd))

expense_domestic_tbl %>%
gt() %>%
cols_label(
expense_category = "Expense category",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
domestic_share = "Domestic share",
cross_border_share = "Cross-border share"
) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_percent(columns = c(domestic_share, cross_border_share), decimals = 1) %>%
tab_header(
title = "Domestic vs Cross-Border Sourcing by Expense Category",
subtitle = "Structural sourcing patterns by contract type"
)
```

### 4C. Trend Over Time ‚Äî Is Cross-Border Sourcing Increasing?

```{r}
library(ggplot2)

domestic_trend <- df %>%
group_by(year) %>%
summarise(
total_spend_usd = sum(spend_usd, na.rm = TRUE),
cross_border_share = sum(spend_usd[!domestic_award], na.rm = TRUE) / sum(spend_usd),
.groups = "drop"
)

domestic_trend %>%
gt() %>%
cols_label(
year = "Year",
total_spend_usd = "Total spend (USD)",
cross_border_share = "Cross-border share"
) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_percent(columns = cross_border_share, decimals = 1) %>%
tab_header(
title = "Cross-Border Sourcing Trend Over Time",
subtitle = "Value-weighted share of cross-border awards"
)

ggplot(domestic_trend, aes(x = year, y = cross_border_share)) +
geom_line() +
geom_point() +
scale_y_continuous(labels = percent) +
labs(
title = "Cross-Border Share of Procurement Spend by Year",
x = NULL,
y = "Cross-border share"
)
```

**Interpretation.**  
Countries and expense categories exhibit substantial variation in domestic sourcing intensity, reflecting differences in supplier market depth and technical requirements.  
A rising cross-border share over time may indicate increased competition and regional integration, but can also signal persistent gaps in domestic supplier capacity for high-value contracts.

## 5. Supplier Concentration & Market Structure

::: {.callout-note}
### üßæ Analytical Focus
Supplier concentration assesses whether procurement spending is broadly distributed across many firms or dominated by a small number of suppliers.  
This section uses the **Herfindahl‚ÄìHirschman Index (HHI)** and Top-supplier shares (Top-1, Top-5) to identify countries and sectors where market depth may be limited or repeated awarding is structurally likely.

These metrics are **screening indicators**: high concentration can be consistent with specialization or thin supplier markets, but it also elevates governance and value-for-money sensitivity for large awards.
:::

### 5A. Helper Function (HHI)

```{r}
library(dplyr)
library(gt)
library(scales)
library(ggplot2)

hhi_calc <- function(x){
s <- x / sum(x, na.rm = TRUE)
sum(s^2, na.rm = TRUE)
}
```

### 5B. Concentration by Project Country

```{r, fig.height=12, fig.width=8}
conc_country <- df %>%
group_by(project_country, bidder_name) %>%
summarise(spend_usd = sum(spend_usd, na.rm = TRUE), .groups = "drop") %>%
group_by(project_country) %>%
summarise(
total_spend_usd = sum(spend_usd, na.rm = TRUE),
suppliers = n(),
hhi = hhi_calc(spend_usd),
top1_share = max(spend_usd, na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),
top5_share = sum(sort(spend_usd, decreasing = TRUE)[seq_len(min(5, dplyr::n()))], na.rm = TRUE) /
             sum(spend_usd, na.rm = TRUE),

.groups = "drop"
) %>%
arrange(desc(hhi))

conc_country %>%
gt() %>%
cols_label(
project_country = "Project country",
total_spend_usd = "Total spend (USD)",
suppliers = "Suppliers (count)",
hhi = "HHI",
top1_share = "Top-1 share",
top5_share = "Top-5 share"
) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_number(columns = suppliers, decimals = 0) %>%
fmt_number(columns = hhi, decimals = 3) %>%
fmt_percent(columns = c(top1_share, top5_share), decimals = 1) %>%
tab_header(
title = "Supplier Concentration by Project Country",
subtitle = "HHI and top-supplier dominance (value-weighted)"
)

ggplot(conc_country, aes(x = reorder(project_country, hhi), y = hhi)) +
geom_col() +
coord_flip() +
geom_hline(yintercept = c(0.10, 0.18), linetype = "dashed", color = "grey40") +
scale_y_continuous(labels = number_format(accuracy = 0.01)) +
labs(
title = "Supplier Concentration by Project Country (HHI)",
x = "Project country",
y = "HHI"
)
```

### 5C. Concentration by Sector

```{r}
conc_sector <- df %>%
group_by(sector, bidder_name) %>%
summarise(spend_usd = sum(spend_usd, na.rm = TRUE), .groups = "drop") %>%
group_by(sector) %>%
summarise(
total_spend_usd = sum(spend_usd, na.rm = TRUE),
suppliers = n(),
hhi = hhi_calc(spend_usd),
top1_share = max(spend_usd, na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),
top5_share = sum(sort(spend_usd, decreasing = TRUE)[1:min(5, n())], na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(hhi))

conc_sector %>%
gt() %>%
cols_label(
sector = "Sector",
total_spend_usd = "Total spend (USD)",
suppliers = "Suppliers (count)",
hhi = "HHI",
top1_share = "Top-1 share",
top5_share = "Top-5 share"
) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_number(columns = suppliers, decimals = 0) %>%
fmt_number(columns = hhi, decimals = 3) %>%
fmt_percent(columns = c(top1_share, top5_share), decimals = 1) %>%
tab_header(
title = "Supplier Concentration by Sector",
subtitle = "HHI and top-supplier dominance (value-weighted)"
)
```

### 5D. Concentration Watchlists (Countries/Sectors with Dominance Thresholds)

```{r}
country_watchlist <- conc_country %>%
filter(hhi > 0.18 | top1_share >= 0.50 | top5_share >= 0.80) %>%
arrange(desc(hhi), desc(top1_share))

sector_watchlist <- conc_sector %>%
filter(hhi > 0.18 | top1_share >= 0.50 | top5_share >= 0.80) %>%
arrange(desc(hhi), desc(top1_share))

country_watchlist %>%
  gt() %>%
  cols_label(
    project_country = "Project country",
    total_spend_usd = "Total spend (USD)",
    suppliers = "Suppliers",
    hhi = "HHI",
    top1_share = "Top-1 share",
    top5_share = "Top-5 share"
  ) %>%
  fmt_currency(
    columns = total_spend_usd,
    currency = "USD",
    decimals = 0
  ) %>%
  fmt_number(
    columns = suppliers,
    decimals = 0
  ) %>%
  fmt_number(
    columns = hhi,
    decimals = 3
  ) %>%
  fmt_percent(
    columns = c(top1_share, top5_share),
    decimals = 1
  ) %>%
  tab_header(
    title = "Country Concentration Watchlist",
    subtitle = "Flagged if HHI > 0.18 OR Top-1 ‚â• 50% OR Top-5 ‚â• 80%"
  )

sector_watchlist %>%
  gt() %>%
  cols_label(
    sector = "Sector",
    total_spend_usd = "Total spend (USD)",
    suppliers = "Suppliers",
    hhi = "HHI",
    top1_share = "Top-1 share",
    top5_share = "Top-5 share"
  ) %>%
  fmt_currency(
    columns = total_spend_usd,
    currency = "USD",
    decimals = 0
  ) %>%
  fmt_number(
    columns = suppliers,
    decimals = 0
  ) %>%
  fmt_number(
    columns = hhi,
    decimals = 3
  ) %>%
  fmt_percent(
    columns = c(top1_share, top5_share),
    decimals = 1
  ) %>%
  tab_header(
    title = "Sector Concentration Watchlist",
    subtitle = "Flagged if HHI > 0.18 OR Top-1 ‚â• 50% OR Top-5 ‚â• 80%"
  )
```

## 6. Repeat-Award & Incumbency Patterns

::: {.callout-note}
### üîÅ Analytical Focus
Repeat awarding is observed when a small set of suppliers win multiple contracts within the same country, sector, or project.  
This section identifies repeat winners and potential incumbency patterns using award counts, total spend, and the number of years a supplier remains active.

These results are **screening indicators**: repeat engagement may reflect specialization, framework arrangements, or long implementation cycles, but sustained dominance can also elevate governance and competition sensitivity.
:::

### 6A. Top repeat winners by Country √ó Sector

```{r}
library(dplyr)
library(gt)
library(scales)

repeat_cs <- df %>%
group_by(project_country, sector, bidder_name) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
years_active = n_distinct(year),
.groups = "drop"
) %>%
arrange(desc(awards), desc(total_spend_usd))

# Top 10 within each country

top_repeat_by_country <- repeat_cs %>%
group_by(project_country) %>%
slice_max(order_by = awards, n = 10, with_ties = FALSE) %>%
ungroup() %>%
arrange(project_country, desc(awards), desc(total_spend_usd))

# Top 10 within each sector

top_repeat_by_sector <- repeat_cs %>%
group_by(sector) %>%
slice_max(order_by = awards, n = 10, with_ties = FALSE) %>%
ungroup() %>%
arrange(sector, desc(awards), desc(total_spend_usd))

top_repeat_by_country %>%
gt(groupname_col = "project_country") %>%
cols_label(
sector = "Sector",
bidder_name = "Supplier",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
years_active = "Years active"
) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_number(columns = years_active, decimals = 0) %>%
tab_header(
title = "Top Repeat Winners Within Each Country",
subtitle = "Top 10 suppliers by award count (with spend and persistence)"
)

top_repeat_by_sector %>%
gt(groupname_col = "sector") %>%
cols_label(
project_country = "Project country",
bidder_name = "Supplier",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
years_active = "Years active"
) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_number(columns = years_active, decimals = 0) %>%
tab_header(
title = "Top Repeat Winners Within Each Sector",
subtitle = "Top 10 suppliers by award count (with spend and persistence)"
)
```

### 6B. Repeat Winners by Project / Loan (incumbency within a project)

```{r}
repeat_project <- df %>%
group_by(project_def, loan_number, bidder_name) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
years_active = n_distinct(year),
.groups = "drop"
) %>%
arrange(desc(awards), desc(total_spend_usd))

repeat_project %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
project_def = "Project",
loan_number = "Loan number",
bidder_name = "Supplier",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
years_active = "Years active"
) %>%
fmt_number(columns = c(awards, years_active), decimals = 0) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
tab_header(
title = "Repeat Winners Within Project / Loan",
subtitle = "Top 50 supplier‚Äìproject pairs by repeat awarding"
)
```

### 6C. Flag: Single Supplier Dominates a Project/Loan (‚â• 80% of project spend)

```{r}
proj_dom <- df %>%
group_by(project_def, loan_number, bidder_name) %>%
summarise(spend_usd = sum(spend_usd, na.rm = TRUE), .groups = "drop") %>%
group_by(project_def, loan_number) %>%
mutate(
project_total_usd = sum(spend_usd, na.rm = TRUE),
share = spend_usd / project_total_usd
) %>%
ungroup() %>%
filter(share >= 0.80) %>%
arrange(desc(share), desc(spend_usd))

proj_dom %>%
slice_head(n = 100) %>%
gt() %>%
cols_label(
project_def = "Project",
loan_number = "Loan number",
bidder_name = "Supplier",
spend_usd = "Supplier spend (USD)",
project_total_usd = "Project total (USD)",
share = "Share of project spend"
) %>%
fmt_currency(columns = c(spend_usd, project_total_usd), currency = "USD", decimals = 0) %>%
fmt_percent(columns = share, decimals = 1) %>%
tab_header(
title = "Project / Loan Dominance Flag",
subtitle = "Supplier captures ‚â• 80% of total project/loan spend (screening list)"
)
```

## 7. Supplier Footprint (Breadth vs Dependence)

::: {.callout-note}
### üß≠ Analytical Focus
A supplier ‚Äúfootprint‚Äù describes how broadly a firm participates across countries, sectors, and years.  
This section distinguishes between suppliers that are **widely active** (multi-country and/or multi-sector) and those that are **highly dependent** on a narrow set of contexts.

High spend combined with a narrow footprint can be consistent with specialization, but it also increases sensitivity to **incumbency effects** and **market thinness** in the supplier‚Äôs operating environments.
:::

### 7A. Supplier Footprint Table (Polished Top-50)

```{r}
library(dplyr)
library(gt)
library(scales)

supplier_footprint <- df %>%
group_by(bidder_name) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
countries_served = n_distinct(project_country),
sectors_served = n_distinct(sector),
years_active = n_distinct(year),
.groups = "drop"
) %>%
arrange(desc(total_spend_usd))

supplier_footprint %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
bidder_name = "Supplier",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
countries_served = "Countries served",
sectors_served = "Sectors served",
years_active = "Years active"
) %>%
fmt_number(
columns = c(awards, countries_served, sectors_served, years_active),
decimals = 0
) %>%
fmt_currency(
columns = total_spend_usd,
currency = "USD",
decimals = 0
) %>%
tab_header(
title = "Top 50 Suppliers by Total Spend ‚Äî Footprint Summary",
subtitle = "Breadth (countries/sectors) and persistence (years active)"
)
```

### 7B. Footprint Typology (Classification + Distribution)

```{r}
supplier_profile <- supplier_footprint %>%
mutate(
footprint_type = case_when(
countries_served == 1 & sectors_served == 1 ~ "Single-country, single-sector",
countries_served == 1 & sectors_served > 1  ~ "Single-country, multi-sector",
countries_served > 1  & sectors_served == 1 ~ "Multi-country, single-sector",
TRUE                                        ~ "Multi-country, multi-sector"
)
)

footprint_counts <- supplier_profile %>%
count(footprint_type, sort = TRUE) %>%
mutate(share = n / sum(n))

footprint_counts %>%
gt() %>%
cols_label(
footprint_type = "Footprint type",
n = "Suppliers (count)",
share = "Share of suppliers"
) %>%
fmt_number(columns = n, decimals = 0) %>%
fmt_percent(columns = share, decimals = 1) %>%
tab_header(
title = "Supplier Footprint Typology",
subtitle = "Distribution of suppliers by breadth of participation"
)
```

### 7C. High-Spend Narrow-Footprint Watchlist (Screening)

```{r}
# High spend threshold (top 5% of suppliers by total spend)

spend_cut <- quantile(supplier_profile$total_spend_usd, 0.95, na.rm = TRUE)

narrow_high_spend <- supplier_profile %>%
filter(total_spend_usd >= spend_cut,
countries_served == 1 | sectors_served == 1) %>%
arrange(desc(total_spend_usd))

narrow_high_spend %>%
gt() %>%
cols_label(
bidder_name = "Supplier",
total_spend_usd = "Total spend (USD)",
awards = "Awards (count)",
countries_served = "Countries served",
sectors_served = "Sectors served",
years_active = "Years active",
footprint_type = "Footprint type"
) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_number(columns = c(awards, countries_served, sectors_served, years_active), decimals = 0) %>%
tab_header(
title = "High-Spend Narrow-Footprint Watchlist",
subtitle = "Suppliers with high total spend but limited breadth (screening list)"
)
```

## 8. Contract Fragmentation & Threshold Clustering

::: {.callout-note}
### üß© Analytical Focus
Contract fragmentation occurs when procurement activity within a project or loan is split into many small awards, often clustering around common approval thresholds.  
This section screens for fragmentation using **award counts**, **micro-award shares**, and **near-threshold clustering**, which can indicate packaging issues, capacity constraints, or approval-driven structuring.

These indicators are **screening signals**, not proof of non-compliance, and are intended to prioritize follow-up review.
:::

### 8A. Project / Loan Fragmentation Summary

```{r}
library(dplyr)
library(gt)
library(scales)

frag_proj <- df %>%
group_by(project_def, loan_number) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
median_award_usd = median(spend_usd, na.rm = TRUE),
p_below_50k  = mean(spend_usd <  50000, na.rm = TRUE),
p_below_100k = mean(spend_usd < 100000, na.rm = TRUE),
p_below_250k = mean(spend_usd < 250000, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(awards), desc(total_spend_usd))

frag_proj %>%
slice_head(n = 100) %>%
gt() %>%
cols_label(
project_def = "Project",
loan_number = "Loan number",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
median_award_usd = "Median award (USD)",
p_below_50k = "Share < USD 50k",
p_below_100k = "Share < USD 100k",
p_below_250k = "Share < USD 250k"
) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_currency(
columns = c(total_spend_usd, median_award_usd),
currency = "USD",
decimals = 0
) %>%
fmt_percent(
columns = c(p_below_50k, p_below_100k, p_below_250k),
decimals = 1
) %>%
tab_header(
title = "Project / Loan Fragmentation Summary",
subtitle = "Award counts and micro-award shares (screening view)"
)
```

### 8B. Fragmentation Watchlist (Many Awards + High Micro - Award Share)

```{r}
frag_watchlist <- frag_proj %>%
filter(
awards >= 30 &
(p_below_50k >= 0.50 | p_below_100k >= 0.70)
) %>%
arrange(desc(awards), desc(p_below_50k))

frag_watchlist %>%
gt() %>%
cols_label(
project_def = "Project",
loan_number = "Loan number",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
p_below_50k = "Share < USD 50k",
p_below_100k = "Share < USD 100k"
) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_percent(columns = c(p_below_50k, p_below_100k), decimals = 1) %>%
tab_header(
title = "Fragmentation Watchlist",
subtitle = "Projects with many awards and high micro-award shares"
)
```

### 8C (i). "Main Mass" View (Winsorized Viewport Via Coord_Cartesian)

```{r}
library(ggplot2)
library(scales)

x_cap <- quantile(df$spend_usd, 0.99, na.rm = TRUE)

ggplot(df, aes(x = spend_usd)) +
geom_histogram(bins = 120, fill = "grey80", color = "white") +
coord_cartesian(xlim = c(0, x_cap)) +
scale_x_continuous(labels = label_dollar()) +
labs(
title = "Award Size Distribution (Zoomed to 99th Percentile)",
subtitle = paste0("X-axis capped at ", dollar(x_cap), " using coord_cartesian()"),
x = "Award size (USD)",
y = "Count of awards"
)
```

### 8C (ii). Threshold Story View

```{r}
library(dplyr)
library(ggplot2)
library(scales)

df_band <- df %>% filter(spend_usd >= 5000, spend_usd <= 500000)

ggplot(df_band, aes(x = spend_usd)) +
geom_histogram(bins = 140, fill = "grey80", color = "white") +
geom_vline(
xintercept = c(50000, 100000, 250000),
linetype = "dashed",
color = "grey40"
) +
scale_x_continuous(labels = label_dollar()) +
labs(
title = "Award Size Distribution (USD 5k‚Äì500k) with Threshold Markers",
subtitle = "Filtered view to focus on the range where threshold clustering is meaningful",
x = "Award size (USD)",
y = "Count of awards"
)
```

### 8C (iii) "Near-Threshold Windows"

```{r}
library(dplyr)
library(ggplot2)
library(scales)

thresholds <- c(50000, 100000, 250000)
window_pct <- 0.20  # +/- 20% window

df_windows <- bind_rows(lapply(thresholds, function(t) {
lo <- t * (1 - window_pct)
hi <- t * (1 + window_pct)
df %>%
filter(spend_usd >= lo, spend_usd <= hi) %>%
mutate(
threshold_value = t,
threshold_label = dollar(t)
)
}))

ggplot(df_windows, aes(x = spend_usd)) +
geom_histogram(bins = 60, fill = "grey80", color = "white") +
geom_vline(aes(xintercept = threshold_value),
linetype = "dashed", color = "grey40") +
facet_wrap(~ threshold_label, scales = "free_x") +
scale_x_continuous(
labels = label_dollar(),
breaks = breaks_pretty(n = 4)   # fewer ticks per facet
) +
labs(
title = "Near-Threshold Clustering Windows",
subtitle = "Histogram within ¬±20% of each threshold (dashed line = threshold)",
x = "Award size (USD)",
y = "Count of awards"
) +
theme_minimal(base_size = 11) +
theme(
axis.text.x = element_text(angle = 30, hjust = 1),
strip.text = element_text(face = "bold")
)
```

### 8D. Quantitative Heaping Metric (Near Threshold Share)

```{r}
band_share <- function(threshold, width = 0.05) {
lo <- threshold * (1 - width)
hi <- threshold
mean(df$spend_usd >= lo & df$spend_usd < hi, na.rm = TRUE)
}

heaping_tbl <- tibble::tibble(
threshold_usd = c(50000, 100000, 250000),
share_in_last_5pct = c(
band_share(50000),
band_share(100000),
band_share(250000)
)
)

heaping_tbl %>%
gt() %>%
cols_label(
threshold_usd = "Threshold (USD)",
share_in_last_5pct = "Share of awards in last 5% below threshold"
) %>%
fmt_currency(columns = threshold_usd, currency = "USD", decimals = 0) %>%
fmt_percent(columns = share_in_last_5pct, decimals = 2) %>%
tab_header(
title = "Near-Threshold Heaping Metric",
subtitle = "Fraction of awards clustering just below common thresholds"
)
```

## 9. Project Procurement Intensity & Complexity

::: {.callout-note}
### üß† Analytical Focus
Projects differ in how procurement activity is structured: some rely on a small number of large contracts, while others involve many awards, suppliers, and procurement methods.  
This section evaluates **procurement intensity** (how much activity occurs) and **complexity** (how fragmented and diverse that activity is) at the project level.

These metrics are **screening indicators** designed to flag projects that may require stronger procurement planning, coordination, or contract management capacity.
:::

### 9A. Project - Level Procurement Intensity

```{r}
library(dplyr)
library(gt)
library(scales)

proj_intensity <- df %>%
group_by(project_def) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
avg_award_usd = mean(spend_usd, na.rm = TRUE),
suppliers = n_distinct(bidder_name),
methods = n_distinct(proc_mode),
.groups = "drop"
) %>%
arrange(desc(awards))

proj_intensity %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
project_def = "Project",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
avg_award_usd = "Average award (USD)",
suppliers = "Suppliers (count)",
methods = "Procurement methods"
) %>%
fmt_number(columns = c(awards, suppliers, methods), decimals = 0) %>%
fmt_currency(
columns = c(total_spend_usd, avg_award_usd),
currency = "USD",
decimals = 0
) %>%
tab_header(
title = "Project Procurement Intensity",
subtitle = "Top 50 projects by number of awards"
)
```

### 9B. Largest Projects by Total Spend

```{r}
proj_intensity %>%
arrange(desc(total_spend_usd)) %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
project_def = "Project",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
avg_award_usd = "Average award (USD)",
suppliers = "Suppliers (count)",
methods = "Procurement methods"
) %>%
fmt_number(columns = c(awards, suppliers, methods), decimals = 0) %>%
fmt_currency(
columns = c(total_spend_usd, avg_award_usd),
currency = "USD",
decimals = 0
) %>%
tab_header(
title = "Largest Projects by Total Spend",
subtitle = "Context for scale versus procurement intensity"
)
```

### 9C. Project Procurement Complexity Index (Composite Screening Metric)

```{r}
proj_complexity <- proj_intensity %>%
mutate(
complexity_index =
scale(awards)[, 1] +
scale(suppliers)[, 1] +
scale(methods)[, 1]
) %>%
arrange(desc(complexity_index))

proj_complexity %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
  project_def = "Project",
  awards = "Awards (count)",
  total_spend_usd = "Total spend (USD)",
  avg_award_usd = "Average award size (USD)",
  suppliers = "Suppliers (count)",
  methods = "Procurement methods",
  complexity_index = "Complexity index"
) %>%
fmt_number(columns = complexity_index, decimals = 2) %>%
fmt_number(columns = c(awards, suppliers, methods), decimals = 0) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
tab_header(
title = "Project Procurement Complexity Index",
subtitle = "Composite of award volume, supplier diversity, and method diversity"
)
```

### 9D. Complexity Index Visualization

```{r}
library(ggplot2)

ggplot(
proj_complexity %>% slice_head(n = 30),
aes(x = reorder(project_def, complexity_index),
y = complexity_index)
) +
geom_col(fill = "grey40") +
coord_flip() +
labs(
title = "Top 30 Projects by Procurement Complexity",
x = "Project",
y = "Composite complexity score"
) +
theme_minimal(base_size = 11)
```

### 9E. Micro-Contract Intensity (High - Activity Projects Only)

```{r}
library(dplyr)
library(gt)
library(scales)

proj_micro2 <- df %>%
group_by(project_def) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),

micro_awards_50k = sum(spend_usd < 50000, na.rm = TRUE),
micro_awards_100k = sum(spend_usd < 100000, na.rm = TRUE),

share_awards_lt_50k  = micro_awards_50k / awards,
share_awards_lt_100k = micro_awards_100k / awards,

share_spend_lt_50k  = sum(spend_usd[spend_usd < 50000], na.rm = TRUE) / total_spend_usd,
share_spend_lt_100k = sum(spend_usd[spend_usd < 100000], na.rm = TRUE) / total_spend_usd,
.groups = "drop"

) %>%

# Only show projects with meaningful activity

filter(awards >= 20) %>%

# Rank by micro-award volume first, then share

arrange(desc(micro_awards_100k), desc(share_awards_lt_100k))

proj_micro2 %>%
  slice_head(n = 50) %>%
  select(
    project_def,
    awards,
    total_spend_usd,
    micro_awards_100k,
    share_awards_lt_100k,
    share_spend_lt_100k
  ) %>%
  gt() %>%
  cols_label(
    project_def = "Project",
    awards = "Total awards",
    total_spend_usd = "Total spend (USD)",
    micro_awards_100k = "Awards below USD 100k (count)",
    share_awards_lt_100k = "Share of awards below USD 100k",
    share_spend_lt_100k = "Share of spend below USD 100k"
  ) %>%
  fmt_number(
    columns = c(awards, micro_awards_100k),
    decimals = 0
  ) %>%
  fmt_currency(
    columns = total_spend_usd,
    currency = "USD",
    decimals = 0
  ) %>%
  fmt_percent(
    columns = c(share_awards_lt_100k, share_spend_lt_100k),
    decimals = 1
  ) %>%
  tab_header(
    title = "Micro-Contract Intensity by Project (High-Activity Projects)",
    subtitle = "Projects with ‚â• 20 awards; ranked by number of awards below USD 100k"
  )
```

### üß≠ How to Interpret Section 9 (Procurement Intensity & Complexity)

Section 9 is designed as a **screening lens**, not a performance ranking or compliance verdict.

- **Procurement intensity** reflects *how much procurement activity* occurs within a project (number of awards, suppliers, and methods). High intensity often corresponds to complex implementation environments or decentralized delivery structures.
- The **complexity index** combines award volume, supplier diversity, and method diversity into a single metric. Projects with high scores are not inherently problematic, but they typically require **stronger procurement planning, coordination, and contract management capacity**.
- **Micro-contract intensity** highlights projects where a large share of activity is driven by small awards. When observed in **high-activity projects**, this pattern may indicate transactional overload, packaging constraints, or approval-driven structuring.

Importantly, these indicators should be interpreted **together**, not in isolation.  
A project with many small awards but low overall spend may pose limited risk, while a project with high award counts, high complexity, and high micro-award volume warrants closer review of procurement design, supervision arrangements, and implementation capacity.

