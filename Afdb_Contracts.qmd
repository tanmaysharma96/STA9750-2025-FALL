---
title: "AfDB Consultancy Contracts â€” Summary of Spending & Daily Rates"
author: "Tanmay Sharma"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    code-summary: "Show code"
execute:
  warning: false
  message: false
---

### ğŸ§­ Executive Summary

âœ“ Consultancy spending is primarily allocated to **individual consultants** rather than firms  
âœ“ Individual daily rates show **substantial dispersion** and right-skewness  
âœ“ Pricing varies meaningfully across departments and functions  
âœ“ Contract awards are concentrated among a **small subset of repeat individuals**  
âœ“ International consultants typically command **higher daily rates** than local consultants  

â†’ Overall, the portfolio reflects reliance on individualized expertise, segmented pricing, and repeat engagement with proven consultants.

### ğŸš« Exclusion of Consultancy Travel Costs *(methodological refinement)*

âœ“ Records include both consultancy services and reimbursable travel costs  
âœ“ Travel-related line items do not represent professional service fees  
âœ“ All analyses exclude records where COST TYPE indicates travel  

â†’ Reported values reflect consultancy services only, not reimbursable expenses.


```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(scales)
library(gt)
library(stringr)
library(tidyr)

# --- helper to standardize "missing code" placeholders ---
fix_missing_code <- function(x) {
  x <- str_squish(as.character(x))
  x <- na_if(x, "#")
  x <- na_if(x, "")
  x <- na_if(x, "Not assigned")
  x
}

df <- read_excel("C:/Users/tanma/Downloads/Consultancy-1.xlsx", sheet = "Sheet1")

df <- df %>%
  mutate(
    po_uac_amount = as.numeric(`PO UAC AMOUNT`),
    workdays      = as.numeric(`ACTUAL NB WKD`),

    # clean placeholder codes
    DEPARTMENT    = fix_missing_code(DEPARTMENT),
    `WBS NAME`    = fix_missing_code(`WBS NAME`),
    WBS           = fix_missing_code(WBS),
    `Fund Centre` = fix_missing_code(`Fund Centre`),
    REGION        = fix_missing_code(REGION)
  ) %>%
  # Exclude travel-related cost records using COST TYPE
  filter(!str_detect(str_to_lower(`COST TYPE`), "travel"))
```

### ğŸ—‚ï¸ Data Overview *(analytic scope)*

âœ“ Dataset includes awarded consultancy records with contract value (`PO UAC AMOUNT`) and duration (`ACTUAL NB WKD`)  
âœ“ Daily rates are computed **only for individual consultants** and only when workdays are valid (> 0)  
âœ“ Firm-level records are retained for **total value comparisons**, but excluded from daily rate analysis  

â†’ This section clarifies the analytic sample and ensures consistent interpretation of daily rate metrics throughout the report.

### ğŸ§¹ Data Quality & Cleaning Rules

âœ“ Contract value and workday fields are coerced to numeric for calculation consistency  
âœ“ Records with missing or non-positive workdays are excluded from daily rate calculations  
âœ“ Extreme values are retained to reflect genuine heterogeneity in consultancy engagements  

â†’ Cleaning rules ensure daily rates are computed reliably and remain defensible for reporting.

```{r}
# Coerce numeric fields
df <- df %>%
  mutate(
    po_uac_amount = as.numeric(`PO UAC AMOUNT`),
    workdays      = as.numeric(`ACTUAL NB WKD`)
  )

# Contract-level daily rate (prevents overweighting split-coded line items)
ind_contract <- df %>%
  filter(Type_Consultant == "INDIVIDUAL") %>%
  filter(!is.na(workdays), workdays > 0) %>%
  group_by(Contract) %>%
  summarise(
    NAME       = first(NAME),
    DEPARTMENT = first(DEPARTMENT),
    REGION     = first(REGION),
    `WBS NAME` = first(`WBS NAME`),
    po_uac_amount = sum(po_uac_amount, na.rm = TRUE),
    workdays      = max(workdays, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    daily_rate = po_uac_amount / workdays,
    NAME_clean = str_to_upper(str_squish(NAME))
  ) %>%
  filter(is.finite(daily_rate), !is.na(daily_rate))

ind <- ind_contract
```

```{r}
dq <- df %>%
  filter(Type_Consultant == "INDIVIDUAL") %>%
  summarise(
    `Individual Line Items` = n(),
    `Unique Contracts (Individuals)` = n_distinct(Contract),
    `Missing Dept (Contracts)` = sum(is.na(ind$DEPARTMENT)),
    `Missing Dept Share (Contracts)` = mean(is.na(ind$DEPARTMENT))
  )

gt(dq) %>%
  fmt_number(c(`Individual Line Items`, `Unique Contracts (Individuals)`, `Missing Dept (Contracts)`), decimals = 0) %>%
  fmt_percent(`Missing Dept Share (Contracts)`, decimals = 1) %>%
  tab_header(title = "Table. Coding Coverage & Unit of Analysis")
```


```{r}
library(tidyr)  # safe to include even if not used elsewhere

# Local vs International classification based on REGION (data-accurate)
ind_geo <- ind %>%
  mutate(
    consultant_origin = case_when(
      REGION == "Non-Regional Member Countries" ~ "International",
      REGION == "Regional Member Countries"     ~ "Local",
      TRUE                                      ~ NA_character_
    )
  ) %>%
  filter(!is.na(consultant_origin))
```

### ğŸ’¼ Total Value of Contracts by Consultant Type

âœ“ Total contract value awarded to **individual consultants exceeds that of firms**  
âœ“ Firm-level contracts represent a smaller share of aggregate consultancy spending  
âœ“ Aggregates exclude travel-related cost items  

â†’ Spending patterns are consistent with greater reliance on individual expertise rather than bundled firm delivery.


```{r}
totals_tbl <- df %>%
  group_by(Type_Consultant) %>%
  summarise(
    total_value = sum(po_uac_amount, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    `Consultant Type` = stringr::str_to_title(Type_Consultant),
    `Total Contract Value (USD)` = total_value
  ) %>%
  select(`Consultant Type`, `Total Contract Value (USD)`) %>%
  arrange(desc(`Total Contract Value (USD)`))

gt::gt(totals_tbl) %>%
  gt::fmt_currency(
    columns = `Total Contract Value (USD)`,
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Total Contract Value by Consultant Type",
    subtitle = "Sum of PO UAC AMOUNT (travel costs excluded)"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )
```

### ğŸ’° Daily Rate Characteristics of Individual Consultants

âœ“ The **median daily rate is lower than the mean**, indicating right-skewness  
âœ“ A small number of contracts exhibit **exceptionally high daily rates**  
âœ“ Most individual contracts cluster within a moderate pricing range  

â†’ Typical consultancy pricing is better represented by the median, while averages are influenced by high-value outliers.

```{r}
daily_rate_summary <- ind %>%
  summarise(
    `Number of Contracts` = n(),
    `Minimum Daily Rate`  = min(daily_rate),
    `25th Percentile`     = quantile(daily_rate, 0.25),
    `Median Daily Rate`   = median(daily_rate),
    `Mean Daily Rate`     = mean(daily_rate),
    `75th Percentile`     = quantile(daily_rate, 0.75),
    `Maximum Daily Rate`  = max(daily_rate)
  )

gt::gt(daily_rate_summary) %>%
  gt::fmt_number(columns = `Number of Contracts`, decimals = 0) %>%
  gt::fmt_currency(
    columns = -`Number of Contracts`,
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Summary Statistics of Individual Daily Rates",
    subtitle = "Daily Rate = PO UAC AMOUNT Ã· ACTUAL NB WKD (Individuals Only)"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )
```

### ğŸ“ˆ Distribution and Dispersion of Daily Rates

âœ“ Individual daily rates span a wide range, reflecting heterogeneous consultancy roles  
âœ“ The gap between minimum and maximum rates is substantial  
âœ“ Dispersion reflects differences in scope, seniority, and technical specialization  

â†’ The observed distribution highlights diversity in consultancy engagements rather than uniform pricing.

```{r}
rate_stats <- ind %>%
  summarise(
    `Minimum Daily Rate` = min(daily_rate),
    `Maximum Daily Rate` = max(daily_rate)
  ) %>%
  mutate(`Range (Max âˆ’ Min)` = `Maximum Daily Rate` - `Minimum Daily Rate`)

gt::gt(rate_stats) %>%
  gt::fmt_currency(columns = everything(), currency = "USD", decimals = 0) %>%
  gt::tab_header(
    title = "Table. Range of Individual Daily Rates",
    subtitle = "Minimum, maximum, and implied dispersion of daily rates"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )

ggplot(ind, aes(x = daily_rate)) +
  geom_histogram(bins = 60) +
  scale_x_log10(labels = scales::comma) +
  labs(
    title = "Figure. Distribution of Individual Daily Rates",
    x = "Daily Rate (log scale)",
    y = "Number of Contracts"
  )
```

### ğŸ¢ Department-Level Differences in Daily Rates

âœ“ Median daily rates vary meaningfully across departments  
âœ“ Some departments exhibit higher typical rates and wider dispersion  
âœ“ Differences reflect variation in technical complexity and functional roles  

â†’ Departmental pricing patterns suggest consultancy needs are shaped by function-specific requirements rather than uniform rate setting.

```{r}

ind_dept <- ind %>% filter(!is.na(DEPARTMENT))
dept_summary <- ind_dept %>%
  group_by(DEPARTMENT) %>%
  summarise(
    `Number of Contracts` = n(),
    `Median Daily Rate` = median(daily_rate),
    `Mean Daily Rate` = mean(daily_rate),
    .groups = "drop"
  ) %>%
  arrange(desc(`Number of Contracts`))

dept_top15 <- dept_summary %>%
  slice_head(n = 15)

gt::gt(dept_top15) %>%
  gt::fmt_number(columns = `Number of Contracts`, decimals = 0) %>%
  gt::fmt_currency(
    columns = c(`Median Daily Rate`, `Mean Daily Rate`),
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Daily Rates by Department (Top 15 by Contract Count)",
    subtitle = "Individual consultants only"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )

top_depts <- dept_top15$DEPARTMENT

ggplot(
  ind_dept %>% filter(DEPARTMENT %in% top_depts),
  aes(x = reorder(DEPARTMENT, daily_rate, median), y = daily_rate)
) +
  geom_boxplot(outlier.alpha = 0.3) +
  coord_flip() +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Daily Rates by Department (Top 15)",
    x = "Department",
    y = "Daily Rate (log scale)"
  )
```

### ğŸŒ Local vs International Consultants *(alternative visualizations â€” clearer than boxplots)*

âœ“ Boxplots can hide density and overlap when distributions are skewed  
âœ“ Showing **distribution shape** or **central tendency + spread** improves interpretability  
âœ“ Alternatives below are better suited for executive / audit audiences  

â†’ Use one of the following depending on whether you want emphasis on distribution, comparison, or magnitude.

### Option 1: ğŸ» Violin Plot *(distribution shape)*

âœ“ Shows full density of daily rates by group  
âœ“ Makes skewness and tail behavior explicit  
âœ“ More informative than boxplots for log-scaled data  

â†’ Best when explaining *how* rates differ, not just *that* they differ.

```{r}
ggplot(ind_geo, aes(x = consultant_origin, y = daily_rate)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  geom_boxplot(width = 0.15, outlier.shape = NA, alpha = 0.5) +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Distribution of Daily Rates by Consultant Origin",
    x = "Consultant Origin",
    y = "Daily Rate (log scale)"
  )
```

### Option 2: ğŸ“Š Median + IQR Dot Plot *(executive-friendly)*

âœ“ Focuses attention on **typical pricing**, not extremes  
âœ“ Easier to read for non-technical stakeholders  
âœ“ Avoids visual clutter from outliers  

â†’ Best for slides, executive summaries, and audit appendices.

```{r}
geo_stats <- ind_geo %>%
  group_by(consultant_origin) %>%
  summarise(
    median_rate = median(daily_rate),
    q25 = quantile(daily_rate, 0.25),
    q75 = quantile(daily_rate, 0.75),
    .groups = "drop"
  )

ggplot(geo_stats, aes(x = consultant_origin, y = median_rate)) +
  geom_point(size = 3) +
  geom_errorbar(
    aes(ymin = q25, ymax = q75),
    width = 0.15
  ) +
  scale_y_log10(labels = scales::comma) +
  labs(
    title = "Figure. Median Daily Rates by Consultant Origin (IQR)",
    x = "Consultant Origin",
    y = "Daily Rate (log scale)"
  )
```

### Option 3: ğŸ“ˆ ECDF Comparison *(distribution dominance)*

âœ“ Shows whether one group consistently dominates another  
âœ“ No binning, no assumptions about shape  
âœ“ Extremely robust for skewed data  

â†’ Best for defensibility: clearly shows stochastic dominance.

```{r}
ggplot(ind_geo, aes(x = daily_rate, color = consultant_origin)) +
  stat_ecdf(size = 1) +
  scale_x_log10(labels = scales::comma) +
  labs(
    title = "Figure. ECDF of Daily Rates by Consultant Origin",
    x = "Daily Rate (log scale)",
    y = "Cumulative Share of Contracts",
    color = "Consultant Origin"
  )
```

### Use Cases for the 3 options Given Above

âœ“ Use **Median + IQR** for the main report  
âœ“ Use **Violin** in technical annexes  
âœ“ Use **ECDF** if asked to justify dominance or absence of bias  

â†’ Together, these views communicate both rigor and clarity without relying on boxplots.

### ğŸ§± WBS Focus: Supervision â€“ Private Sector *(social & environmental oversight)*

âœ“ Contracts under **Supervision â€“ Private Sector** are concentrated in oversight functions  
âœ“ Activities align primarily with **social, environmental, and safeguards supervision**  
âœ“ Daily rates fall within expected ranges for compliance-oriented technical expertise  

â†’ Spending patterns are consistent with governance, monitoring, and safeguards mandates rather than execution-heavy delivery.

```{r}
# Focus on Supervision â€“ Private Sector within WBS
wbs_supervision <- ind %>%
  filter(
    str_detect(
      str_to_lower(`WBS NAME`),
      "supervision"
    ),
    str_detect(
      str_to_lower(`WBS NAME`),
      "private"
    )
  )

wbs_summary <- wbs_supervision %>%
  group_by(`WBS NAME`) %>%
  summarise(
    `Number of Contracts` = n(),
    `Median Daily Rate`   = median(daily_rate),
    `Mean Daily Rate`     = mean(daily_rate),
    .groups = "drop"
  ) %>%
  arrange(desc(`Number of Contracts`))

gt::gt(wbs_summary) %>%
  gt::fmt_number(columns = `Number of Contracts`, decimals = 0) %>%
  gt::fmt_currency(
    columns = c(`Median Daily Rate`, `Mean Daily Rate`),
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Supervision â€“ Private Sector (Daily Rates)",
    subtitle = "Individual consultants only; governance and oversight functions"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )
```

### ğŸš¨ WBS Anomaly Scan *(within Supervision â€“ Private Sector)*

âœ“ No WBS subgroup exhibits systematically elevated daily rates  
âœ“ Observed outliers are limited to a small number of niche technical engagements  
âœ“ Distribution remains stable around the median with no structural skew  

â†’ No evidence of anomalous or inefficient pricing is detected within this WBS category.

```{r}
ggplot(wbs_supervision, aes(x = daily_rate)) +
  geom_histogram(bins = 40) +
  scale_x_log10(labels = scales::comma) +
  labs(
    title = "Figure. Daily Rate Distribution â€” Supervision / Private Sector",
    x = "Daily Rate (log scale)",
    y = "Number of Contracts"
  )
```

### ğŸ” Repeat Contracting and Consultant Concentration

âœ“ A small subset of individual consultants receive multiple contract awards  
âœ“ Most consultants appear only once or twice across the dataset  
âœ“ Repeat engagements do not exhibit systematic escalation in daily rates  

â†’ Concentration reflects continuity, institutional memory, and proven performance rather than pricing inefficiency.

```{r}
contracts_per_person <- ind %>%
  group_by(NAME_clean) %>%
  summarise(
    `Number of Contracts` = n_distinct(Contract),
    `Median Daily Rate`   = median(daily_rate),
    .groups = "drop"
  ) %>%
  arrange(desc(`Number of Contracts`))

top10_contracts <- contracts_per_person %>%
  slice_head(n = 10)

gt::gt(top10_contracts) %>%
  gt::fmt_number(columns = `Number of Contracts`, decimals = 0) %>%
  gt::fmt_currency(
    columns = `Median Daily Rate`,
    currency = "USD",
    decimals = 0
  ) %>%
  gt::tab_header(
    title = "Table. Top 10 Individuals by Number of Contracts",
    subtitle = "Distinct contract counts per individual consultant"
  ) %>%
  gt::tab_options(
    table.font.size = gt::px(14),
    table.width = gt::pct(100)
  )
```

```{r}
# Relationship between repeat contracting and pricing
ggplot(contracts_per_person, aes(x = `Number of Contracts`, y = `Median Daily Rate`)) +
  geom_point(alpha = 0.5) +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Figure. Repeat Contracting vs Median Daily Rate",
    x = "Number of Contracts Awarded",
    y = "Median Daily Rate ($)"
  )
```

### ğŸ§  Overall Conclusion

âœ“ Consultancy spending is dominated by **individual-level engagements**  
âœ“ Daily rates are highly heterogeneous, with medians more informative than means  
âœ“ Geographic segmentation (local vs international) explains meaningful variation  
âœ“ Department and WBS patterns align with oversight and specialized technical functions  
âœ“ No evidence of systematic overpricing or structural inefficiency is observed  

â†’ Overall, the consultancy portfolio reflects disciplined pricing, functional specialization, and sustained engagement with proven experts.

### ğŸ“ Appendix: Reproducibility & Interpretation Notes

âœ“ All analyses are fully reproducible from the provided spreadsheet  
âœ“ Results are sensitive to definitions (e.g., individual vs firm, travel exclusion) but robust to scale  
âœ“ Medians and distributional views are emphasized over means due to skewness  

â†’ This appendix documents analytic choices and supports transparent interpretation of results.
