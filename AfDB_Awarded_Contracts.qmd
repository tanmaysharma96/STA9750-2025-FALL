---
title: "AfDB Awarded Contracts"
author: "Tanmay Sharma"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: true
    code-summary: "Show code"
execute:
  warning: false
  message: false
---

## Data Import & Preparation

::: {.callout-note}
### üìò Introduction
This report analyzes AfDB awarded contract records (2020‚Äì2025) to understand **procurement method mix**, **domestic vs cross-border sourcing**, **supplier concentration**, and **risk screening flags**.  
We begin by importing the Excel extract, standardizing key fields, and constructing clean analytical variables (e.g., USD spend, procurement mode, domestic award indicator).
:::

```{r}
rm(list = ls())
gc()

library(readxl)
library(dplyr)
library(janitor)
library(stringr)
library(readr)
library(ggplot2)
library(scales)
library(gt)

# Use the attached file path (recommended for portability)

path <- "C:/Users/tanma/Downloads/listing_of_awarded_contracts_from_2020_to_2025_-_october_2025 (3).xlsx"

raw <- read_excel(path, skip = 2)

to_num <- function(x){
if (is.numeric(x)) return(x)
readr::parse_number(as.character(x))
}

df <- raw %>%
clean_names() %>%
select(where(~ !all(is.na(.)))) %>%
mutate(
year = as.integer(year),
spend_usd = to_num(equiv_usd),
cont_uac = to_num(cont_am_uac),

project_def = str_squish(as.character(project_def)),
loan_number = str_squish(as.character(loan_number)),
bidder_name = str_squish(as.character(bidder_name)),
bidder_nationality = str_squish(as.character(bidder_nationality)),
project_country = str_squish(as.character(project_country)),
sector = str_squish(as.character(sector)),
proc_mode = str_squish(as.character(proc_mode)),
expense_category = str_squish(as.character(expense_category)),

domestic_award = (str_to_upper(bidder_nationality) == str_to_upper(project_country))

) %>%
filter(!is.na(year), !is.na(spend_usd)) %>%
filter(year >= 2020, year <= 2025)

# Polished "Data snapshot" table (no tibble printing)

df %>%
  summarise(
    rows_awards = n(),
    years_covered = paste0(min(year, na.rm = TRUE), "‚Äì", max(year, na.rm = TRUE)),
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    median_award_usd = median(spend_usd, na.rm = TRUE),
    distinct_countries = n_distinct(project_country),
    distinct_suppliers = n_distinct(bidder_name),
    distinct_sectors = n_distinct(sector),
    distinct_proc_modes = n_distinct(proc_mode)
  ) %>%
  gt() %>%
  cols_label(
    rows_awards = "Rows (awards)",
    years_covered = "Years covered",
    total_spend_usd = "Total spend (USD)",
    median_award_usd = "Median award (USD)",
    distinct_countries = "Distinct countries",
    distinct_suppliers = "Distinct suppliers",
    distinct_sectors = "Distinct sectors",
    distinct_proc_modes = "Distinct procurement modes"
  ) %>%
  fmt_number(
    columns = c(rows_awards, distinct_countries, distinct_suppliers, distinct_sectors, distinct_proc_modes),
    decimals = 0
  ) %>%
  fmt_currency(
    columns = c(total_spend_usd, median_award_usd),
    currency = "USD",
    decimals = 0
  ) %>%
  tab_header(
    title = "Data Import Snapshot",
    subtitle = "AfDB Awarded Contracts (filtered to 2020‚Äì2025)"
  )
```

## Data Cleaning & Standardization

::: {.callout-note}
### üßπ Cleanup Overview
Raw procurement extracts often contain inconsistent capitalization, stray whitespace, duplicated category labels, and Excel-generated placeholder columns.  
This section standardizes key categorical fields (procurement mode, expense category, sector, country, and supplier names) to ensure that downstream grouping, aggregation, and risk screening are analytically valid and reproducible.

The cleanup process focuses on **harmonization rather than transformation**‚Äîno records are dropped, and no financial values are altered‚Äîso that all subsequent analysis reflects the original awarded-contract universe.
:::

```{r}
library(dplyr)
library(stringr)
library(gt)

# Snapshot BEFORE cleanup (for audit table)

audit_before <- df %>%
summarise(
stage = "Before cleanup",
rows_awards = n(),
missing_proc_mode = sum(is.na(proc_mode) | proc_mode == ""),
missing_expense_category = sum(is.na(expense_category) | expense_category == ""),
missing_sector = sum(is.na(sector) | sector == ""),
distinct_proc_modes = n_distinct(proc_mode),
distinct_expense_categories = n_distinct(expense_category),
distinct_sectors = n_distinct(sector)
)

# Cleanup / standardization

df_clean <- df %>%
select(-matches("^x\\d+$")) %>%  # drops x18, x19, x20 etc
mutate(
proc_mode          = str_to_upper(str_squish(proc_mode)),
expense_category   = str_to_upper(str_squish(expense_category)),
sector             = str_squish(sector),
project_country    = str_squish(project_country),
bidder_nationality = str_squish(bidder_nationality),
bidder_name        = str_squish(bidder_name),
project_def        = str_squish(project_def),
loan_number        = str_squish(loan_number)
)

# Snapshot AFTER cleanup (for audit table)

audit_after <- df_clean %>%
summarise(
stage = "After cleanup",
rows_awards = n(),
missing_proc_mode = sum(is.na(proc_mode) | proc_mode == ""),
missing_expense_category = sum(is.na(expense_category) | expense_category == ""),
missing_sector = sum(is.na(sector) | sector == ""),
distinct_proc_modes = n_distinct(proc_mode),
distinct_expense_categories = n_distinct(expense_category),
distinct_sectors = n_distinct(sector)
)

# Polished audit table (no tibble printing)

bind_rows(audit_before, audit_after) %>%
gt() %>%
cols_label(
stage = "Stage",
rows_awards = "Rows (awards)",
missing_proc_mode = "Missing procurement mode",
missing_expense_category = "Missing expense category",
missing_sector = "Missing sector",
distinct_proc_modes = "Distinct procurement modes",
distinct_expense_categories = "Distinct expense categories",
distinct_sectors = "Distinct sectors"
) %>%
fmt_number(
columns = c(
rows_awards,
missing_proc_mode, missing_expense_category, missing_sector,
distinct_proc_modes, distinct_expense_categories, distinct_sectors
),
decimals = 0
) %>%
tab_header(
title = "Cleanup Audit (Before vs After)",
subtitle = "Counts and distinct levels used for grouping"
)

# Overwrite df so downstream code remains unchanged

df <- df_clean
```

## Method Mix vs Contract Value

::: {.callout-note}
### üìä Analytical Focus
Procurement methods differ not only in how frequently they are used, but also in the **value of contracts they carry**.  
This section examines the distribution of award sizes by procurement mode to assess whether higher-value contracts are systematically concentrated in particular methods.

The analysis emphasizes **value-weighted metrics and upper-tail behavior**, since governance, competition, and value-for-money risks are typically greatest for large awards rather than for small, routine contracts.
:::

### Percentile & Value Share Table (Polished Output)

```{r}
library(dplyr)
library(gt)
library(scales)

method_value_tbl <- df %>%
  group_by(proc_mode) %>%
  summarise(
    awards = n(),
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    p25 = quantile(spend_usd, 0.25, na.rm = TRUE),
    p50 = quantile(spend_usd, 0.50, na.rm = TRUE),
    p75 = quantile(spend_usd, 0.75, na.rm = TRUE),
    p90 = quantile(spend_usd, 0.90, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    usd_share = total_spend_usd / sum(total_spend_usd, na.rm = TRUE),
    award_share = awards / sum(awards, na.rm = TRUE)
  ) %>%
  arrange(desc(total_spend_usd))

method_value_tbl %>%
  gt() %>%
  cols_label(
    proc_mode = "Procurement mode",
    awards = "Awards (count)",
    award_share = "Share of contract awards",
    total_spend_usd = "Total spend (USD)",
    usd_share = "Share of total spend",
    p25 = "P25 award (USD)",
    p50 = "Median award (USD)",
    p75 = "P75 award (USD)",
    p90 = "P90 award (USD)"
  ) %>%
  fmt_number(columns = awards, decimals = 0) %>%
  fmt_currency(
    columns = c(total_spend_usd, p25, p50, p75, p90),
    currency = "USD",
    decimals = 0
  ) %>%
  fmt_percent(columns = c(award_share, usd_share), decimals = 1) %>%
  tab_header(
    title = "Procurement Method Mix ‚Äî Contract Value Distribution",
    subtitle = "Award percentiles and value-weighted share (2020‚Äì2025)"
  )
```

**Interpretation.**  
Procurement modes vary substantially in both typical contract size (median) and upper-tail exposure (P90).  
Modes carrying a disproportionate share of total spend warrant closer scrutiny to ensure that competition intensity and procurement approach remain aligned with contract value.

### Distribution Visual (Log Scale)

```{r}
library(dplyr)
library(ggplot2)
library(scales)

# Desired order (codes remain unchanged in df)
mode_order <- c("ICB","NCB","LIC","ISH","NSH","SHL","DNP")

# Full-form labels for plotting ONLY (does not modify df$proc_mode)
mode_labels <- c(
  ICB = "ICB ‚Äî International Competitive Bidding",
  NCB = "NCB ‚Äî National Competitive Bidding",
  LIC = "LIC ‚Äî Limited International Competitive Bidding",
  ISH = "ISH ‚Äî International Shopping",
  NSH = "NSH ‚Äî National Shopping",
  SHL = "SHL ‚Äî Short List",
  DNP = "DNP ‚Äî Direct Negotiation / Procurement"
)

df_plot <- df %>%
  filter(!is.na(proc_mode), proc_mode != "") %>%                 # drop NA/blank
  mutate(proc_mode = toupper(proc_mode)) %>%                     # safety: standardize case
  filter(proc_mode %in% mode_order) %>%                          # keep only the 7 modes
  mutate(proc_mode = factor(proc_mode, levels = mode_order))     # enforce x order

ggplot(df_plot, aes(x = proc_mode, y = spend_usd, fill = proc_mode)) +
  geom_violin(trim = TRUE, alpha = 0.70, color = NA) +
  geom_boxplot(width = 0.18, outlier.alpha = 0.12, color = "grey20", fill = "white") +
  stat_summary(fun = median, geom = "point", size = 2.2, color = "grey10") +
  scale_y_log10(
    labels = label_dollar(),
    breaks = c(1e3, 1e4, 1e5, 1e6, 1e7, 1e8)
  ) +
  scale_x_discrete(labels = mode_labels) +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  annotation_logticks(sides = "l", color = "grey60") +
  labs(
    title = "Award Size Distribution by Procurement Mode",
    subtitle = "Violin = distribution; box = IQR; point = median (log scale)",
    x = NULL,
    y = "Award size (USD, log scale)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 25, hjust = 1),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )
```

## Domestic vs Cross-Border Sourcing

::: {.callout-note}
### üåç Analytical Focus
Domestic sourcing is defined as cases where the **supplier nationality matches the project country**.  
This section examines how procurement spend is split between domestic and cross-border suppliers, providing insight into **local market depth**, **supplier capacity**, and **reliance on international firms**.

Results are presented at the **country**, **expense-category**, and **time-series** levels to distinguish structural patterns from short-term fluctuations.
:::

### Country-Level Domestic vs Cross-Border Share

```{r}
library(dplyr)
library(gt)
library(scales)
library(stringr)

# Define "Infrastructure" sectors (per your definition)
infra_sectors <- c("WATER SUPPLY", "POWER", "TRANSPORT", "COMMUNICATIONS")

# Clean sector just for this section's logic (does not overwrite df)
df_country <- df %>%
  mutate(
    sector_std = str_to_upper(str_squish(as.character(sector))),
    project_country_std = str_squish(as.character(project_country))
  )

# --- Main table: EXCLUDE Multi-Countries ---
country_domestic_tbl <- df_country %>%
  filter(!is.na(project_country_std), project_country_std != "") %>%
  filter(str_to_upper(project_country_std) != "MULTI-COUNTRIES") %>%
  group_by(project_country = project_country_std) %>%
  summarise(
    awards = n(),
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    median_award_usd = median(spend_usd, na.rm = TRUE),
    domestic_spend_usd = sum(spend_usd[domestic_award], na.rm = TRUE),
    domestic_share = domestic_spend_usd / total_spend_usd,
    cross_border_share = 1 - domestic_share,
    infra_spend_usd = sum(spend_usd[sector_std %in% infra_sectors], na.rm = TRUE),
    infra_share = infra_spend_usd / total_spend_usd,
    .groups = "drop"
  ) %>%
  arrange(desc(total_spend_usd))

country_domestic_tbl %>%
  gt() %>%
  cols_label(
    project_country = "Project country",
    awards = "Awards (count)",
    total_spend_usd = "Total spend (USD)",
    median_award_usd = "Median award (USD)",
    infra_spend_usd = "Infrastructure spend (USD)",
    infra_share = "Infrastructure share of total spend",
    domestic_spend_usd = "Domestic spend (USD)",
    domestic_share = "Domestic share",
    cross_border_share = "Cross-border share"
  ) %>%
  fmt_number(columns = awards, decimals = 0) %>%
  fmt_currency(
    columns = c(total_spend_usd, domestic_spend_usd, median_award_usd, infra_spend_usd),
    currency = "USD",
    decimals = 0
  ) %>%
  fmt_percent(columns = c(infra_share, domestic_share, cross_border_share), decimals = 1) %>%
  tab_header(
    title = "Domestic vs Cross-Border Sourcing by Country (Excluding Multi-Countries)",
    subtitle = "Adds award-size context and infrastructure dependence (2020‚Äì2025)"
  ) %>%
  tab_source_note(
    source_note = md("Infrastructure = **Water Supply + Power + Transport + Communications**.")
  )
```

### Cross-Border Share Heat Map (Country √ó Year)

```{r}
library(dplyr)
library(ggplot2)
library(scales)
library(stringr)
library(sf)
library(rnaturalearth)
library(countrycode)
library(plotly)

# --- Compute cross-border share by country (exclude Multi-Countries) ---
cross_border_country <- df %>%
  mutate(project_country_std = str_squish(as.character(project_country))) %>%
  filter(!is.na(project_country_std), project_country_std != "") %>%
  filter(str_to_upper(project_country_std) != "MULTI-COUNTRIES") %>%
  group_by(project_country = project_country_std) %>%
  summarise(
    awards = n(),
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    cross_border_share = sum(spend_usd[!domestic_award], na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(iso3 = countrycode(project_country, origin = "country.name", destination = "iso3c"))

# --- Africa map + join ---
africa_sf <- ne_countries(scale = "medium", returnclass = "sf") %>%
  filter(continent == "Africa")

africa_map_df <- africa_sf %>%
  left_join(cross_border_country, by = c("iso_a3" = "iso3")) %>%
  mutate(
    hover = ifelse(
      is.na(cross_border_share),
      paste0("<b>", name, "</b><br>No data in extract"),
      paste0(
        "<b>", name, "</b>",
        "<br>Cross-border share: ", scales::percent(cross_border_share, accuracy = 0.1),
        "<br>Total spend: ", scales::dollar(total_spend_usd, accuracy = 1),
        "<br>Awards: ", format(awards, big.mark = ",")
      )
    )
  )

# --- Static ggplot base (with hover text) ---
p <- ggplot(africa_map_df) +
  geom_sf(aes(fill = cross_border_share, text = hover), color = "white", linewidth = 0.25) +
  scale_fill_viridis_c(
    option = "C",
    labels = percent_format(accuracy = 1),
    limits = c(0, 1),
    na.value = "grey92",
    name = "Cross-border share"
  ) +
  labs(
    title = "Cross-Border Share of Procurement Spend (Africa Map)",
    subtitle = "Hover to see country name + metrics (2020‚Äì2025). Multi-Countries excluded."
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold"),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )

# --- Convert to interactive plotly ---
ggplotly(p, tooltip = "text") %>%
  layout(margin = list(l = 10, r = 10, b = 10, t = 60))
```

### Domestic Share by Expense Category

```{r}
expense_keep <- c("WORKS", "GOODS", "SERVICES")

expense_domestic_tbl <- df %>%
  mutate(expense_category = toupper(trimws(as.character(expense_category)))) %>%
  filter(!is.na(expense_category), expense_category %in% expense_keep) %>%
  group_by(expense_category) %>%
  summarise(
    awards = n(),
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    domestic_share = sum(spend_usd[domestic_award], na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),
    cross_border_share = 1 - domestic_share,
    .groups = "drop"
  ) %>%
  arrange(match(expense_category, expense_keep))  # WORKS, GOODS, SERVICES order

expense_domestic_tbl %>%
  gt() %>%
  cols_label(
    expense_category = "Expense category",
    awards = "Awards (count)",
    total_spend_usd = "Total spend (USD)",
    domestic_share = "Domestic share",
    cross_border_share = "Cross-border share"
  ) %>%
  fmt_number(columns = awards, decimals = 0) %>%
  fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
  fmt_percent(columns = c(domestic_share, cross_border_share), decimals = 1) %>%
  tab_header(
    title = "Domestic vs Cross-Border Sourcing by Expense Category",
    subtitle = "Structural sourcing patterns by contract type (Works, Goods, Services only)"
  )
```

### Trend Over Time ‚Äî Is Cross-Border Sourcing Increasing?

```{r}
library(dplyr)
library(stringr)
library(countrycode)
library(gt)
library(scales)
library(ggplot2)
library(tidyr)

# --- Prep: classify supplier nationality by continent, drop 2025 ---
df_trend <- df %>%
  filter(!is.na(year), year <= 2024) %>%     # REMOVE 2025
  mutate(
    bidder_nat_std = str_squish(as.character(bidder_nationality)),
    bidder_continent = countrycode(bidder_nat_std, origin = "country.name", destination = "continent"),
    supplier_in_africa = (bidder_continent == "Africa")
  )

# --- Build trend table ---
domestic_trend <- df_trend %>%
  group_by(year) %>%
  summarise(
    total_spend_usd = sum(spend_usd, na.rm = TRUE),

    cross_border_share =
      sum(spend_usd[!domestic_award], na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),

    cross_border_within_africa_share =
      sum(spend_usd[!domestic_award & supplier_in_africa %in% TRUE], na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),

    cross_border_outside_africa_share =
      sum(spend_usd[!domestic_award & supplier_in_africa %in% FALSE], na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),

    .groups = "drop"
  )

# --- Table output ---
domestic_trend %>%
  gt() %>%
  cols_label(
    year = "Year",
    total_spend_usd = "Total spend (USD)",
    cross_border_share = "Cross-border share (total)",
    cross_border_within_africa_share = "Cross-border share (within Africa)",
    cross_border_outside_africa_share = "Cross-border share (outside Africa)"
  ) %>%
  fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
  fmt_percent(
    columns = c(
      cross_border_share,
      cross_border_within_africa_share,
      cross_border_outside_africa_share
    ),
    decimals = 1
  ) %>%
  tab_header(
    title = "Cross-Border Sourcing Trend Over Time (Africa vs Outside Africa)",
    subtitle = "2020‚Äì2024 only; cross-border split by supplier nationality continent"
  )

# --- Prepare data for plotting ---
trend_long <- domestic_trend %>%
  select(year, cross_border_within_africa_share, cross_border_outside_africa_share) %>%
  pivot_longer(
    cols = -year,
    names_to = "series",
    values_to = "share"
  ) %>%
  mutate(
    series = recode(
      series,
      cross_border_within_africa_share = "Cross-border (within Africa)",
      cross_border_outside_africa_share = "Cross-border (outside Africa)"
    )
  )

# --- Trend chart ---
ggplot(trend_long, aes(x = year, y = share, color = series)) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Cross-Border Share of Procurement Spend by Year",
    subtitle = "Within Africa vs Outside Africa (2020‚Äì2024)",
    x = NULL,
    y = "Share of total spend",
    color = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom"
  )
```

**Interpretation.**  
Countries and expense categories exhibit substantial variation in domestic sourcing intensity, reflecting differences in supplier market depth and technical requirements.  
A rising cross-border share over time may indicate increased competition and regional integration, but can also signal persistent gaps in domestic supplier capacity for high-value contracts.

## Supplier Concentration & Market Structure

::: {.callout-note}
### üßæ Analytical Focus
Supplier concentration assesses whether procurement spending is broadly distributed across many firms or dominated by a small number of suppliers.  
This section uses the **Herfindahl‚ÄìHirschman Index (HHI)** and Top-supplier shares (Top-1, Top-5) to identify countries and sectors where market depth may be limited or repeated awarding is structurally likely.

These metrics are **screening indicators**: high concentration can be consistent with specialization or thin supplier markets, but it also elevates governance and value-for-money sensitivity for large awards.
:::

### Helper Function (HHI)

```{r}
library(dplyr)
library(gt)
library(scales)
library(ggplot2)

hhi_calc <- function(x){
s <- x / sum(x, na.rm = TRUE)
sum(s^2, na.rm = TRUE)
}
```

### Concentration by Project Country

```{r, fig.height=12, fig.width=8}
library(dplyr)
library(gt)
library(scales)
library(ggplot2)

# Helper: Herfindahl‚ÄìHirschman Index (HHI)
hhi_calc <- function(x) {
  s <- x / sum(x, na.rm = TRUE)
  sum(s^2, na.rm = TRUE)
}

conc_country <- df %>%
  filter(!is.na(project_country), project_country != "") %>%
  group_by(project_country, bidder_name) %>%
  summarise(spend_usd = sum(spend_usd, na.rm = TRUE), .groups = "drop") %>%
  group_by(project_country) %>%
  summarise(
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    suppliers = n(),
    hhi = hhi_calc(spend_usd),
    top1_share = max(spend_usd, na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),
    top5_share = sum(sort(spend_usd, decreasing = TRUE)[seq_len(min(5, dplyr::n()))], na.rm = TRUE) /
      sum(spend_usd, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(total_spend_usd))

# Table (sorted by total spend)
conc_country %>%
  gt() %>%
  cols_label(
    project_country = "Project country",
    total_spend_usd = "Total spend (USD)",
    suppliers = "Suppliers (count)",
    hhi = "HHI",
    top1_share = "Top-1 share",
    top5_share = "Top-5 share"
  ) %>%
  fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
  fmt_number(columns = suppliers, decimals = 0) %>%
  fmt_number(columns = hhi, decimals = 3) %>%
  fmt_percent(columns = c(top1_share, top5_share), decimals = 1) %>%
  tab_header(
    title = "Supplier Concentration by Project Country",
    subtitle = "Sorted by total spend (highest first); HHI and top-supplier dominance (value-weighted)"
  )

# HHI graph (keep)
ggplot(conc_country, aes(x = reorder(project_country, hhi), y = hhi)) +
  geom_col(fill = "grey50") +
  coord_flip() +
  geom_hline(yintercept = c(0.10, 0.18), linetype = "dashed", color = "grey40") +
  scale_y_continuous(labels = number_format(accuracy = 0.01)) +
  labs(
    title = "Supplier Concentration by Project Country (HHI)",
    subtitle = "Dashed lines at HHI = 0.10 and 0.18 (screening thresholds)",
    x = "Project country",
    y = "HHI"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold"),
    panel.grid.major.y = element_blank()
  )
```

### Concentration by Sector

```{r}
library(dplyr)
library(stringr)
library(gt)
library(scales)

# Helper if not already defined in an earlier chunk
hhi_calc <- function(x) {
  s <- x / sum(x, na.rm = TRUE)
  sum(s^2, na.rm = TRUE)
}

infra_sectors <- c("WATER SUPPLY", "POWER", "TRANSPORT", "COMMUNICATIONS")

conc_sector <- df %>%
  mutate(
    sector_std = str_to_upper(str_squish(as.character(sector))),
    sector_group = if_else(sector_std %in% infra_sectors, "INFRASTRUCTURE", sector_std)
  ) %>%
  group_by(sector = sector_group, bidder_name) %>%
  summarise(spend_usd = sum(spend_usd, na.rm = TRUE), .groups = "drop") %>%
  group_by(sector) %>%
  summarise(
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    suppliers = n(),
    hhi = hhi_calc(spend_usd),
    top1_share = max(spend_usd, na.rm = TRUE) / sum(spend_usd, na.rm = TRUE),
    top5_share = sum(sort(spend_usd, decreasing = TRUE)[1:min(5, dplyr::n())], na.rm = TRUE) /
      sum(spend_usd, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(hhi))

conc_sector %>%
  gt() %>%
  cols_label(
    sector = "Sector",
    total_spend_usd = "Total spend (USD)",
    suppliers = "Suppliers (count)",
    hhi = "HHI",
    top1_share = "Top-1 share",
    top5_share = "Top-5 share"
  ) %>%
  fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
  fmt_number(columns = suppliers, decimals = 0) %>%
  fmt_number(columns = hhi, decimals = 3) %>%
  fmt_percent(columns = c(top1_share, top5_share), decimals = 1) %>%
  tab_header(
    title = "Supplier Concentration by Sector",
    subtitle = "Infrastructure = Water Supply + Power + Transport + Communications (value-weighted)"
  )
```

### Concentration Watchlists (Countries/Sectors with Dominance Thresholds)

```{r}
country_watchlist <- conc_country %>%
filter(hhi > 0.18 | top1_share >= 0.50 | top5_share >= 0.80) %>%
arrange(desc(hhi), desc(top1_share))

sector_watchlist <- conc_sector %>%
filter(hhi > 0.18 | top1_share >= 0.50 | top5_share >= 0.80) %>%
arrange(desc(hhi), desc(top1_share))

country_watchlist %>%
  gt() %>%
  cols_label(
    project_country = "Project country",
    total_spend_usd = "Total spend (USD)",
    suppliers = "Suppliers",
    hhi = "HHI",
    top1_share = "Top-1 share",
    top5_share = "Top-5 share"
  ) %>%
  fmt_currency(
    columns = total_spend_usd,
    currency = "USD",
    decimals = 0
  ) %>%
  fmt_number(
    columns = suppliers,
    decimals = 0
  ) %>%
  fmt_number(
    columns = hhi,
    decimals = 3
  ) %>%
  fmt_percent(
    columns = c(top1_share, top5_share),
    decimals = 1
  ) %>%
  tab_header(
    title = "Country Concentration Watchlist",
    subtitle = "Flagged if HHI > 0.18 OR Top-1 ‚â• 50% OR Top-5 ‚â• 80%"
  )

sector_watchlist %>%
  gt() %>%
  cols_label(
    sector = "Sector",
    total_spend_usd = "Total spend (USD)",
    suppliers = "Suppliers",
    hhi = "HHI",
    top1_share = "Top-1 share",
    top5_share = "Top-5 share"
  ) %>%
  fmt_currency(
    columns = total_spend_usd,
    currency = "USD",
    decimals = 0
  ) %>%
  fmt_number(
    columns = suppliers,
    decimals = 0
  ) %>%
  fmt_number(
    columns = hhi,
    decimals = 3
  ) %>%
  fmt_percent(
    columns = c(top1_share, top5_share),
    decimals = 1
  ) %>%
  tab_header(
    title = "Sector Concentration Watchlist",
    subtitle = "Flagged if HHI > 0.18 OR Top-1 ‚â• 50% OR Top-5 ‚â• 80%"
  )
```

## Repeat-Award & Incumbency Patterns

::: {.callout-note}
### üîÅ Analytical Focus
Repeat awarding is observed when a small set of suppliers win multiple contracts within the same country, sector, or project.  
This section identifies repeat winners and potential incumbency patterns using award counts, total spend, and the number of years a supplier remains active.

These results are **screening indicators**: repeat engagement may reflect specialization, framework arrangements, or long implementation cycles, but sustained dominance can also elevate governance and competition sensitivity.
:::

### Top repeat winners by Country √ó Sector

```{r}
library(dplyr)
library(gt)
library(scales)
library(stringr)

# helper: most frequent (mode) value
mode_chr <- function(x){
  x <- str_squish(as.character(x))
  x <- x[!is.na(x) & x != ""]
  if (length(x) == 0) return(NA_character_)
  names(sort(table(x), decreasing = TRUE))[1]
}

repeat_cs <- df %>%
  group_by(project_country, sector, bidder_name) %>%
  summarise(
    bidder_nationality = mode_chr(bidder_nationality),   # ‚úÖ add nationality
    awards = dplyr::n(),
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    years_active = n_distinct(year),
    .groups = "drop"
  ) %>%
  arrange(desc(awards), desc(total_spend_usd))

# Top 10 within each country
top_repeat_by_country <- repeat_cs %>%
  group_by(project_country) %>%
  slice_max(order_by = awards, n = 10, with_ties = FALSE) %>%
  ungroup() %>%
  arrange(project_country, desc(awards), desc(total_spend_usd))

# Top 10 within each sector
top_repeat_by_sector <- repeat_cs %>%
  group_by(sector) %>%
  slice_max(order_by = awards, n = 10, with_ties = FALSE) %>%
  ungroup() %>%
  arrange(sector, desc(awards), desc(total_spend_usd))

# ---- Table: Top repeat winners within each country ----
top_repeat_by_country %>%
  gt(groupname_col = "project_country") %>%
  cols_label(
    sector = "Sector",
    bidder_name = "Supplier",
    bidder_nationality = "Supplier nationality",
    awards = "Awards (count)",
    total_spend_usd = "Total spend (USD)",
    years_active = "Years active"
  ) %>%
  fmt_number(columns = awards, decimals = 0) %>%
  fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
  fmt_number(columns = years_active, decimals = 0) %>%
  tab_header(
    title = "Top Repeat Winners Within Each Country",
    subtitle = "Top 10 suppliers by award count (with nationality, spend, and persistence)"
  )

# ---- Table: Top repeat winners within each sector ----
top_repeat_by_sector %>%
  gt(groupname_col = "sector") %>%
  cols_label(
    project_country = "Project country",
    bidder_name = "Supplier",
    bidder_nationality = "Supplier nationality",
    awards = "Awards (count)",
    total_spend_usd = "Total spend (USD)",
    years_active = "Years active"
  ) %>%
  fmt_number(columns = awards, decimals = 0) %>%
  fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
  fmt_number(columns = years_active, decimals = 0) %>%
  tab_header(
    title = "Top Repeat Winners Within Each Sector",
    subtitle = "Top 10 suppliers by award count (with nationality, spend, and persistence)"
  )
```

### Repeat Winners by Project / Loan (incumbency within a project)

```{r}
repeat_project <- df %>%
group_by(project_def, loan_number, bidder_name) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
years_active = n_distinct(year),
.groups = "drop"
) %>%
arrange(desc(awards), desc(total_spend_usd))

repeat_project %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
project_def = "Project",
loan_number = "Loan number",
bidder_name = "Supplier",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
years_active = "Years active"
) %>%
fmt_number(columns = c(awards, years_active), decimals = 0) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
tab_header(
title = "Repeat Winners Within Project / Loan",
subtitle = "Top 50 supplier‚Äìproject pairs by repeat awarding"
)
```

### Flag: Single Supplier Dominates a Project/Loan (‚â• 80% of project spend)

```{r}
proj_dom <- df %>%
group_by(project_def, loan_number, bidder_name) %>%
summarise(spend_usd = sum(spend_usd, na.rm = TRUE), .groups = "drop") %>%
group_by(project_def, loan_number) %>%
mutate(
project_total_usd = sum(spend_usd, na.rm = TRUE),
share = spend_usd / project_total_usd
) %>%
ungroup() %>%
filter(share >= 0.80) %>%
arrange(desc(share), desc(spend_usd))

proj_dom %>%
slice_head(n = 100) %>%
gt() %>%
cols_label(
project_def = "Project",
loan_number = "Loan number",
bidder_name = "Supplier",
spend_usd = "Supplier spend (USD)",
project_total_usd = "Project total (USD)",
share = "Share of project spend"
) %>%
fmt_currency(columns = c(spend_usd, project_total_usd), currency = "USD", decimals = 0) %>%
fmt_percent(columns = share, decimals = 1) %>%
tab_header(
title = "Project / Loan Dominance Flag",
subtitle = "Supplier captures ‚â• 80% of total project/loan spend (screening list)"
)
```

## Supplier Footprint (Breadth vs Dependence)

::: {.callout-note}
### üß≠ Analytical Focus
A supplier ‚Äúfootprint‚Äù describes how broadly a firm participates across countries, sectors, and years.  
This section distinguishes between suppliers that are **widely active** (multi-country and/or multi-sector) and those that are **highly dependent** on a narrow set of contexts.

High spend combined with a narrow footprint can be consistent with specialization, but it also increases sensitivity to **incumbency effects** and **market thinness** in the supplier‚Äôs operating environments.
:::

### Supplier Footprint Table (Polished Top-50)

```{r}
library(dplyr)
library(stringr)
library(gt)
library(scales)

# Canonical name cleaner (for grouping only, not display)
clean_name <- function(x){
  x %>%
    toupper() %>%
    str_replace_all("[^A-Z ]", " ") %>%
    str_replace_all("\\b(LTD|LIMITED|CORP|CORPORATION|CO|GROUP|HOLDING|HOLDINGS|INTL|INTERNATIONAL)\\b", "") %>%
    str_squish()
}

df_fp <- df %>%
  mutate(
    bidder_name_raw = str_squish(as.character(bidder_name)),
    bidder_name_key = clean_name(bidder_name_raw),
    bidder_nationality_std = str_squish(as.character(bidder_nationality))
  ) %>%
  filter(!is.na(bidder_name_raw), bidder_name_raw != "")

supplier_footprint_nat <- df_fp %>%
  group_by(bidder_name_raw, bidder_name_key, bidder_nationality_std) %>%
  summarise(
    awards = n(),
    total_spend_usd = sum(spend_usd, na.rm = TRUE),
    countries_served = n_distinct(project_country),
    sectors_served = n_distinct(sector),
    years_active = n_distinct(year),
    .groups = "drop"
  )

name_summary <- supplier_footprint_nat %>%
  group_by(bidder_name_key) %>%
  summarise(
    legal_names = paste(unique(bidder_name_raw), collapse = " | "),
    nationalities_observed = paste(unique(bidder_nationality_std), collapse = " | "),
    nationality_count = n_distinct(bidder_nationality_std),
    .groups = "drop"
  )

supplier_footprint_final <- supplier_footprint_nat %>%
  left_join(name_summary, by = "bidder_name_key") %>%
  arrange(desc(total_spend_usd), bidder_name_key, bidder_nationality_std)

top50 <- supplier_footprint_final %>%
  slice_max(order_by = total_spend_usd, n = 50, with_ties = TRUE) %>%
  arrange(bidder_name_key, desc(total_spend_usd), bidder_nationality_std)

top50 %>%
  gt(groupname_col = "bidder_name_key") %>%
  cols_label(
  bidder_name_raw = "Legal supplier name",
  bidder_nationality_std = "Supplier nationality",
  awards = "Awards",
  total_spend_usd = "Total spend (USD)",
  countries_served = "Countries served",
  sectors_served = "Sectors served",
  years_active = "Years active",
  nationality_count = "Nationality variants",
  nationalities_observed = "All nationalities observed",
  legal_names = "Legal entity name variants"
) %>%
  fmt_number(columns = c(awards, countries_served, sectors_served, years_active, nationality_count), decimals = 0) %>%
  fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
  tab_header(
    title = "Top 50 Suppliers by Total Spend ‚Äî Canonical Name Grouping",
    subtitle = "Suppliers clustered by normalized corporate name to reveal subsidiaries and spelling variants (e.g., Sinohydro)"
  ) %>%
  tab_source_note(
    source_note = md("Rows are grouped by a normalized supplier name (case-insensitive, legal suffixes removed) to visually cluster subsidiaries and spelling variants without merging them.")
  )
```

### Footprint Typology (Classification + Distribution)

```{r}
library(dplyr)
library(gt)
library(scales)

# 1 row per canonical supplier (bidder_name_key)

supplier_footprint <- supplier_footprint_final %>%
group_by(bidder_name_key) %>%
summarise(
awards = sum(awards, na.rm = TRUE),
total_spend_usd = sum(total_spend_usd, na.rm = TRUE),
countries_served = max(countries_served, na.rm = TRUE),
sectors_served = max(sectors_served, na.rm = TRUE),
years_active = max(years_active, na.rm = TRUE),
legal_names = dplyr::first(legal_names),
nationalities_observed = dplyr::first(nationalities_observed),
nationality_count = dplyr::first(nationality_count),
.groups = "drop"
)

supplier_profile <- supplier_footprint %>%
mutate(
footprint_type = case_when(
countries_served == 1 & sectors_served == 1 ~ "Single-country, single-sector",
countries_served == 1 & sectors_served > 1 ~ "Single-country, multi-sector",
countries_served > 1 & sectors_served == 1 ~ "Multi-country, single-sector",
TRUE ~ "Multi-country, multi-sector"
)
)

footprint_counts <- supplier_profile %>%
count(footprint_type, sort = TRUE) %>%
mutate(share = n / sum(n))

footprint_counts %>%
gt() %>%
cols_label(
footprint_type = "Footprint type",
n = "Suppliers (count)",
share = "Share of suppliers"
) %>%
fmt_number(columns = n, decimals = 0) %>%
fmt_percent(columns = share, decimals = 1) %>%
tab_header(
title = "Supplier Footprint Typology",
subtitle = "Distribution of suppliers by breadth of participation"
)
```

### High-Spend Narrow-Footprint Watchlist (Screening)

```{r}
library(dplyr)
library(gt)
library(scales)

# High spend threshold (top 5% of suppliers by total spend)

spend_cut <- quantile(supplier_profile$total_spend_usd, 0.95, na.rm = TRUE)

narrow_high_spend <- supplier_profile %>%
filter(
total_spend_usd >= spend_cut,
countries_served == 1 | sectors_served == 1
) %>%
arrange(desc(total_spend_usd))

narrow_high_spend %>%
select(
bidder_name_key,
legal_names,
total_spend_usd,
awards,
countries_served,
sectors_served,
years_active,
footprint_type
) %>%
gt() %>%
cols_label(
bidder_name_key = "Supplier (canonical)",
legal_names = "Legal entity name variants",
total_spend_usd = "Total spend (USD)",
awards = "Awards (count)",
countries_served = "Countries served",
sectors_served = "Sectors served",
years_active = "Years active",
footprint_type = "Footprint type"
) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_number(columns = c(awards, countries_served, sectors_served, years_active), decimals = 0) %>%
tab_header(
title = "High-Spend Narrow-Footprint Watchlist",
subtitle = "Top 5% of suppliers by spend; flagged if single-country OR single-sector footprint"
)
```

## Contract Fragmentation & Threshold Clustering

::: {.callout-note}
### üß© Analytical Focus
Contract fragmentation occurs when procurement activity within a project or loan is split into many small awards, often clustering around common approval thresholds.  
This section screens for fragmentation using **award counts**, **micro-award shares**, and **near-threshold clustering**, which can indicate packaging issues, capacity constraints, or approval-driven structuring.

These indicators are **screening signals**, not proof of non-compliance, and are intended to prioritize follow-up review.
:::

### Project / Loan Fragmentation Summary

```{r}
library(dplyr)
library(gt)
library(scales)

frag_proj <- df %>%
group_by(project_def, loan_number) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
median_award_usd = median(spend_usd, na.rm = TRUE),
p_below_50k  = mean(spend_usd <  50000, na.rm = TRUE),
p_below_100k = mean(spend_usd < 100000, na.rm = TRUE),
p_below_250k = mean(spend_usd < 250000, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(awards), desc(total_spend_usd))

frag_proj %>%
slice_head(n = 100) %>%
gt() %>%
cols_label(
project_def = "Project",
loan_number = "Loan number",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
median_award_usd = "Median award (USD)",
p_below_50k = "Share < USD 50k",
p_below_100k = "Share < USD 100k",
p_below_250k = "Share < USD 250k"
) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_currency(
columns = c(total_spend_usd, median_award_usd),
currency = "USD",
decimals = 0
) %>%
fmt_percent(
columns = c(p_below_50k, p_below_100k, p_below_250k),
decimals = 1
) %>%
tab_header(
title = "Project / Loan Fragmentation Summary",
subtitle = "Award counts and micro-award shares (screening view)"
)
```

### Fragmentation Watchlist (Many Awards + High Micro - Award Share)

```{r}
frag_watchlist <- frag_proj %>%
filter(
awards >= 30 &
(p_below_50k >= 0.50 | p_below_100k >= 0.70)
) %>%
arrange(desc(awards), desc(p_below_50k))

frag_watchlist %>%
gt() %>%
cols_label(
project_def = "Project",
loan_number = "Loan number",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
p_below_50k = "Share < USD 50k",
p_below_100k = "Share < USD 100k"
) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_percent(columns = c(p_below_50k, p_below_100k), decimals = 1) %>%
tab_header(
title = "Fragmentation Watchlist",
subtitle = "Projects with many awards and high micro-award shares"
)
```

### "Main Mass" View (Winsorized Viewport Via Coord_Cartesian)

```{r}
library(ggplot2)
library(scales)

x_cap <- quantile(df$spend_usd, 0.99, na.rm = TRUE)

ggplot(df, aes(x = spend_usd)) +
geom_histogram(bins = 120, fill = "grey80", color = "white") +
coord_cartesian(xlim = c(0, x_cap)) +
scale_x_continuous(labels = label_dollar()) +
labs(
title = "Award Size Distribution (Zoomed to 99th Percentile)",
subtitle = paste0("X-axis capped at ", dollar(x_cap), " using coord_cartesian()"),
x = "Award size (USD)",
y = "Count of awards"
)
```

### Threshold Story View

```{r}
library(dplyr)
library(ggplot2)
library(scales)

df_band <- df %>% filter(spend_usd >= 5000, spend_usd <= 500000)

ggplot(df_band, aes(x = spend_usd)) +
geom_histogram(bins = 140, fill = "grey80", color = "white") +
geom_vline(
xintercept = c(50000, 100000, 250000),
linetype = "dashed",
color = "grey40"
) +
scale_x_continuous(labels = label_dollar()) +
labs(
title = "Award Size Distribution (USD 5k‚Äì500k) with Threshold Markers",
subtitle = "Filtered view to focus on the range where threshold clustering is meaningful",
x = "Award size (USD)",
y = "Count of awards"
)
```

### "Near-Threshold Windows"

```{r}
library(dplyr)
library(ggplot2)
library(scales)

thresholds <- c(50000, 100000, 250000)
window_pct <- 0.20  # +/- 20% window

df_windows <- bind_rows(lapply(thresholds, function(t) {
lo <- t * (1 - window_pct)
hi <- t * (1 + window_pct)
df %>%
filter(spend_usd >= lo, spend_usd <= hi) %>%
mutate(
threshold_value = t,
threshold_label = dollar(t)
)
}))

ggplot(df_windows, aes(x = spend_usd)) +
geom_histogram(bins = 60, fill = "grey80", color = "white") +
geom_vline(aes(xintercept = threshold_value),
linetype = "dashed", color = "grey40") +
facet_wrap(~ threshold_label, scales = "free_x") +
scale_x_continuous(
labels = label_dollar(),
breaks = breaks_pretty(n = 4)   # fewer ticks per facet
) +
labs(
title = "Near-Threshold Clustering Windows",
subtitle = "Histogram within ¬±20% of each threshold (dashed line = threshold)",
x = "Award size (USD)",
y = "Count of awards"
) +
theme_minimal(base_size = 11) +
theme(
axis.text.x = element_text(angle = 30, hjust = 1),
strip.text = element_text(face = "bold")
)
```

### Quantitative Heaping Metric (Near Threshold Share)

```{r}
band_share <- function(threshold, width = 0.05) {
lo <- threshold * (1 - width)
hi <- threshold
mean(df$spend_usd >= lo & df$spend_usd < hi, na.rm = TRUE)
}

heaping_tbl <- tibble::tibble(
threshold_usd = c(50000, 100000, 250000),
share_in_last_5pct = c(
band_share(50000),
band_share(100000),
band_share(250000)
)
)

heaping_tbl %>%
gt() %>%
cols_label(
threshold_usd = "Threshold (USD)",
share_in_last_5pct = "Share of awards in last 5% below threshold"
) %>%
fmt_currency(columns = threshold_usd, currency = "USD", decimals = 0) %>%
fmt_percent(columns = share_in_last_5pct, decimals = 2) %>%
tab_header(
title = "Near-Threshold Heaping Metric",
subtitle = "Fraction of awards clustering just below common thresholds"
)
```

## Project Procurement Intensity & Complexity

::: {.callout-note}
### üß† Analytical Focus
Projects differ in how procurement activity is structured: some rely on a small number of large contracts, while others involve many awards, suppliers, and procurement methods.  
This section evaluates **procurement intensity** (how much activity occurs) and **complexity** (how fragmented and diverse that activity is) at the project level.

These metrics are **screening indicators** designed to flag projects that may require stronger procurement planning, coordination, or contract management capacity.
:::

### Project - Level Procurement Intensity

```{r}
library(dplyr)
library(gt)
library(scales)

proj_intensity <- df %>%
group_by(project_def) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
avg_award_usd = mean(spend_usd, na.rm = TRUE),
suppliers = n_distinct(bidder_name),
methods = n_distinct(proc_mode),
.groups = "drop"
) %>%
arrange(desc(awards))

proj_intensity %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
project_def = "Project",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
avg_award_usd = "Average award (USD)",
suppliers = "Suppliers (count)",
methods = "Procurement methods"
) %>%
fmt_number(columns = c(awards, suppliers, methods), decimals = 0) %>%
fmt_currency(
columns = c(total_spend_usd, avg_award_usd),
currency = "USD",
decimals = 0
) %>%
tab_header(
title = "Project Procurement Intensity",
subtitle = "Top 50 projects by number of awards"
)
```

### Largest Projects by Total Spend

```{r}
proj_intensity %>%
arrange(desc(total_spend_usd)) %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
project_def = "Project",
awards = "Awards (count)",
total_spend_usd = "Total spend (USD)",
avg_award_usd = "Average award (USD)",
suppliers = "Suppliers (count)",
methods = "Procurement methods"
) %>%
fmt_number(columns = c(awards, suppliers, methods), decimals = 0) %>%
fmt_currency(
columns = c(total_spend_usd, avg_award_usd),
currency = "USD",
decimals = 0
) %>%
tab_header(
title = "Largest Projects by Total Spend",
subtitle = "Context for scale versus procurement intensity"
)
```

### Project Procurement Complexity Index (Composite Screening Metric)

```{r}
proj_complexity <- proj_intensity %>%
mutate(
complexity_index =
scale(awards)[, 1] +
scale(suppliers)[, 1] +
scale(methods)[, 1]
) %>%
arrange(desc(complexity_index))

proj_complexity %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
  project_def = "Project",
  awards = "Awards (count)",
  total_spend_usd = "Total spend (USD)",
  avg_award_usd = "Average award size (USD)",
  suppliers = "Suppliers (count)",
  methods = "Procurement methods",
  complexity_index = "Complexity index"
) %>%
fmt_number(columns = complexity_index, decimals = 2) %>%
fmt_number(columns = c(awards, suppliers, methods), decimals = 0) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
tab_header(
title = "Project Procurement Complexity Index",
subtitle = "Composite of award volume, supplier diversity, and method diversity"
)
```

### Complexity Index Visualization

```{r}
library(ggplot2)

ggplot(
proj_complexity %>% slice_head(n = 30),
aes(x = reorder(project_def, complexity_index),
y = complexity_index)
) +
geom_col(fill = "grey40") +
coord_flip() +
labs(
title = "Top 30 Projects by Procurement Complexity",
x = "Project",
y = "Composite complexity score"
) +
theme_minimal(base_size = 11)
```

### Micro-Contract Intensity (High - Activity Projects Only)

```{r}
library(dplyr)
library(gt)
library(scales)

proj_micro2 <- df %>%
group_by(project_def) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),

micro_awards_50k = sum(spend_usd < 50000, na.rm = TRUE),
micro_awards_100k = sum(spend_usd < 100000, na.rm = TRUE),

share_awards_lt_50k  = micro_awards_50k / awards,
share_awards_lt_100k = micro_awards_100k / awards,

share_spend_lt_50k  = sum(spend_usd[spend_usd < 50000], na.rm = TRUE) / total_spend_usd,
share_spend_lt_100k = sum(spend_usd[spend_usd < 100000], na.rm = TRUE) / total_spend_usd,
.groups = "drop"

) %>%

# Only show projects with meaningful activity

filter(awards >= 20) %>%

# Rank by micro-award volume first, then share

arrange(desc(micro_awards_100k), desc(share_awards_lt_100k))

proj_micro2 %>%
  slice_head(n = 50) %>%
  select(
    project_def,
    awards,
    total_spend_usd,
    micro_awards_100k,
    share_awards_lt_100k,
    share_spend_lt_100k
  ) %>%
  gt() %>%
  cols_label(
    project_def = "Project",
    awards = "Total awards",
    total_spend_usd = "Total spend (USD)",
    micro_awards_100k = "Awards below USD 100k (count)",
    share_awards_lt_100k = "Share of awards below USD 100k",
    share_spend_lt_100k = "Share of spend below USD 100k"
  ) %>%
  fmt_number(
    columns = c(awards, micro_awards_100k),
    decimals = 0
  ) %>%
  fmt_currency(
    columns = total_spend_usd,
    currency = "USD",
    decimals = 0
  ) %>%
  fmt_percent(
    columns = c(share_awards_lt_100k, share_spend_lt_100k),
    decimals = 1
  ) %>%
  tab_header(
    title = "Micro-Contract Intensity by Project (High-Activity Projects)",
    subtitle = "Projects with ‚â• 20 awards; ranked by number of awards below USD 100k"
  )
```

### üß≠ How to Interpret Section 9 (Procurement Intensity & Complexity)

Section 9 is designed as a **screening lens**, not a performance ranking or compliance verdict.

- **Procurement intensity** reflects *how much procurement activity* occurs within a project (number of awards, suppliers, and methods). High intensity often corresponds to complex implementation environments or decentralized delivery structures.
- The **complexity index** combines award volume, supplier diversity, and method diversity into a single metric. Projects with high scores are not inherently problematic, but they typically require **stronger procurement planning, coordination, and contract management capacity**.
- **Micro-contract intensity** highlights projects where a large share of activity is driven by small awards. When observed in **high-activity projects**, this pattern may indicate transactional overload, packaging constraints, or approval-driven structuring.

Importantly, these indicators should be interpreted **together**, not in isolation.  
A project with many small awards but low overall spend may pose limited risk, while a project with high award counts, high complexity, and high micro-award volume warrants closer review of procurement design, supervision arrangements, and implementation capacity.

## Integrity & Probity Screening (Red-Flag Registry)

::: {.callout-note}
### üö© Analytical Focus
This section consolidates signals from earlier analyses into a **single, evidence-based screening registry**.  
The flags below are **not findings of non-compliance**; they are prioritization tools to guide follow-up questions, document review, and supervisory attention.

Each flag is triggered by transparent, pre-defined rules grounded in procurement analytics best practice.
:::

### Defining Screening Thresholds (Explict and Auditable)

```{r}
# High-value cut (top 5% of awards)

hv_cut <- quantile(df$spend_usd, 0.95, na.rm = TRUE)

# Low-competition methods (adjust if your policy definition differs)

low_comp_modes <- c("DNP", "SHL", "NSH", "ISH")
```

### Flag 1 - High Value Awards Under Low Competition Methods

```{r}
flag_hv_lowcomp <- df %>%
filter(proc_mode %in% low_comp_modes, spend_usd >= hv_cut) %>%
transmute(
flag = "High-value award under low-competition method",
year, project_country, sector, expense_category, proc_mode,
bidder_name, bidder_nationality,
project_def, loan_number, tender_num, contr_no,
spend_usd
)
```

### Flag 2 - Single Supplier Dominates a Project / Loan (‚â• 80% of spend))

```{r}
proj_supplier_share <- df %>%
group_by(project_def, loan_number, bidder_name) %>%
summarise(spend_usd = sum(spend_usd, na.rm = TRUE), .groups = "drop") %>%
group_by(project_def, loan_number) %>%
mutate(
project_total_usd = sum(spend_usd, na.rm = TRUE),
share = spend_usd / project_total_usd
) %>%
ungroup()

flag_project_dom <- proj_supplier_share %>%
filter(share >= 0.80) %>%
transmute(
flag = "Single supplier dominates project/loan (‚â•80% of spend)",
year = NA_integer_,
project_country = NA_character_,
sector = NA_character_,
expense_category = NA_character_,
proc_mode = NA_character_,
bidder_name,
bidder_nationality = NA_character_,
project_def, loan_number,
tender_num = NA_character_,
contr_no = NA_character_,
spend_usd,
extra = paste0("Share=", scales::percent(share))
)
```

### Flag 3 - Fragmentation (Many Awards + High Micro-Award Share)

```{r}
frag_proj <- df %>%
group_by(project_def, loan_number) %>%
summarise(
awards = dplyr::n(),
total_spend_usd = sum(spend_usd, na.rm = TRUE),
p_below_50k  = mean(spend_usd <  50000, na.rm = TRUE),
p_below_100k = mean(spend_usd < 100000, na.rm = TRUE),
.groups = "drop"
)

flag_frag <- frag_proj %>%
filter(awards >= 30 & (p_below_50k >= 0.50 | p_below_100k >= 0.70)) %>%
transmute(
flag = "Fragmentation: many awards + high micro-award share",
year = NA_integer_,
project_country = NA_character_,
sector = NA_character_,
expense_category = NA_character_,
proc_mode = NA_character_,
bidder_name = NA_character_,
bidder_nationality = NA_character_,
project_def, loan_number,
tender_num = NA_character_,
contr_no = NA_character_,
spend_usd = total_spend_usd,
extra = paste0(
"awards=", awards,
"; <50k=", scales::percent(p_below_50k),
"; <100k=", scales::percent(p_below_100k)
)
)
```

### Flag 4 - High-Concentration Context (Country/Sector)

```{r}
high_conc_countries <- conc_country %>%
filter(hhi > 0.18 | top1_share >= 0.50 | top5_share >= 0.80) %>%
transmute(
project_country,
country_extra = paste0(
"HHI=", round(hhi, 3),
"; Top1=", scales::percent(top1_share),
"; Top5=", scales::percent(top5_share)
)
)

high_conc_sectors <- conc_sector %>%
filter(hhi > 0.18 | top1_share >= 0.50 | top5_share >= 0.80) %>%
transmute(
sector,
sector_extra = paste0(
"HHI=", round(hhi, 3),
"; Top1=", scales::percent(top1_share),
"; Top5=", scales::percent(top5_share)
)
)

flag_high_conc_context <- df %>%
left_join(high_conc_countries, by = "project_country") %>%
left_join(high_conc_sectors, by = "sector") %>%
filter(!is.na(country_extra) | !is.na(sector_extra)) %>%
transmute(
flag = "Award in high-concentration country/sector (context)",
year, project_country, sector, expense_category, proc_mode,
bidder_name, bidder_nationality,
project_def, loan_number, tender_num, contr_no,
spend_usd,
extra = paste(
ifelse(is.na(country_extra), "", paste0("Country: ", country_extra)),
ifelse(is.na(sector_extra), "", paste0("Sector: ", sector_extra)),
sep = " | "
)
)
```

### Consolidated Red-Flag Registry

```{r}
library(dplyr)
library(gt)
library(stringr)
library(scales)

red_flag_registry <- bind_rows(
  flag_hv_lowcomp,
  flag_project_dom,
  flag_frag,
  flag_high_conc_context
) %>%
  mutate(
    level = case_when(
      str_detect(flag, regex("low-competition|high-value", ignore_case = TRUE)) ~ "Award",
      str_detect(flag, regex("dominates|project/loan|fragmentation", ignore_case = TRUE)) ~ "Project / Loan",
      str_detect(flag, regex("context|concentration", ignore_case = TRUE)) ~ "Country / Sector",
      TRUE ~ "Other"
    ),
    reference_value_usd = spend_usd
  ) %>%
  # Keep only fields that are interpretable across flag types (avoid structural NAs)
  select(
    flag, level,
    year,
    project_country, sector,
    project_def, loan_number,
    bidder_name,
    reference_value_usd,
    extra
  ) %>%
  arrange(desc(reference_value_usd))

red_flag_registry %>%
  slice_head(n = 250) %>%
  gt() %>%
  cols_label(
    flag = "Flag",
    level = "Level of analysis",
    year = "Year",
    project_country = "Project country",
    sector = "Sector",
    project_def = "Project",
    loan_number = "Loan number",
    bidder_name = "Supplier (if applicable)",
    reference_value_usd = "Reference value (USD)",
    extra = "Flag details"
  ) %>%
  fmt_currency(columns = reference_value_usd, currency = "USD", decimals = 0) %>%
  fmt_missing(columns = everything(), missing_text = "") %>%   # hide NA for cleaner reading
  tab_header(
    title = "Integrity & Probity Screening Registry (Clean View)",
    subtitle = "Consolidated screening flags shown at their natural level of analysis"
  ) %>%
  tab_source_note(
    source_note = md(
      "Notes: Flags operate at different analytical levels (award vs project/loan vs context). Empty cells reflect fields that are not meaningful for that flag type, not missing data."
    )
  )
```

## Currency Conversion Sanity Check (UAC ‚Üí USD)

::: {.callout-note}
### üí± Analytical Focus
This section performs a **data quality and consistency check** by comparing the contract amount in UAC (`cont_uac`) with its USD equivalent (`spend_usd`).  
We compute an **implied conversion factor** at the award level:

**Implied rate = USD equivalent / UAC amount**

Stable implied rates within a year‚Äìcountry context suggest consistent conversion practices, while extreme outliers or unusually wide dispersion can indicate data issues (e.g., mis-tagged currency, decimal shifts, or conversion errors).
:::

### Compute Implied Conversion Factor at Award Level

```{r}
# ---- Section 11: FX sanity check (shared object) ----
library(dplyr)

fx_award <- df %>%
  filter(
    !is.na(cont_uac), cont_uac > 0,
    !is.na(spend_usd), spend_usd > 0
  ) %>%
  mutate(implied_rate = spend_usd / cont_uac)

summary(fx_award$implied_rate)
```

### Summarize Implied Rates by Year x Country (Median + P10/P90)

```{r}
library(dplyr)
library(gt)
library(scales)

fx_summary <- fx_award %>%
group_by(year, project_country) %>%
summarise(
n = dplyr::n(),
rate_median = median(implied_rate, na.rm = TRUE),
rate_p10 = quantile(implied_rate, 0.10, na.rm = TRUE),
rate_p90 = quantile(implied_rate, 0.90, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(n))

fx_summary %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
year = "Year",
project_country = "Project country",
n = "Awards (count)",
rate_median = "Median implied rate (USD/UAC)",
rate_p10 = "P10 implied rate",
rate_p90 = "P90 implied rate"
) %>%
fmt_number(columns = n, decimals = 0) %>%
fmt_number(columns = c(rate_median, rate_p10, rate_p90), decimals = 4) %>%
tab_header(
title = "Implied Conversion Factor by Year √ó Country",
subtitle = "Median and dispersion bands for USD/UAC implied rates"
)
```

### Year Trend of Median Implied Rate (Chart)

```{r}
library(ggplot2)
library(scales)

fx_year <- fx_award %>%
group_by(year) %>%
summarise(
rate_median = median(implied_rate, na.rm = TRUE),
.groups = "drop"
)

ggplot(fx_year, aes(x = year, y = rate_median)) +
geom_line() + geom_point() +
scale_y_continuous(labels = label_number(accuracy = 0.0001)) +
labs(
title = "Median Implied Conversion Factor by Year",
x = NULL,
y = "USD / UAC (implied)"
) +
theme_minimal(base_size = 11)
```

### Outlier Report (award-level extremes using 1st/99th percentiles)

```{r}
lo <- quantile(fx_award$implied_rate, 0.01, na.rm = TRUE)
hi <- quantile(fx_award$implied_rate, 0.99, na.rm = TRUE)

fx_outliers <- fx_award %>%
filter(implied_rate < lo | implied_rate > hi) %>%
transmute(
year, project_country, sector, expense_category, proc_mode,
bidder_name, bidder_nationality,
project_def, loan_number, tender_num, contr_no,
cont_uac, spend_usd,
implied_rate
) %>%
arrange(desc(implied_rate))

fx_outliers %>%
slice_head(n = 200) %>%
gt() %>%
cols_label(
year = "Year",
project_country = "Project country",
sector = "Sector",
expense_category = "Expense category",
proc_mode = "Procurement mode",
bidder_name = "Supplier",
bidder_nationality = "Supplier nationality",
project_def = "Project",
loan_number = "Loan number",
tender_num = "Tender number",
contr_no = "Contract number",
cont_uac = "Contract amount (UAC)",
spend_usd = "USD equivalent",
implied_rate = "Implied rate (USD/UAC)"
) %>%
fmt_currency(columns = spend_usd, currency = "USD", decimals = 0) %>%
fmt_number(columns = cont_uac, decimals = 0) %>%
fmt_number(columns = implied_rate, decimals = 5) %>%
tab_header(
title = "Implied Conversion Factor Outliers",
subtitle = "Awards outside the 1st‚Äì99th percentile implied-rate range (screening list)"
)
```

### Country/Year ‚Äúinstability‚Äù flags (wide p10‚Äìp90 bands)

```{r}
fx_instability <- fx_summary %>%
mutate(spread = rate_p90 - rate_p10) %>%
arrange(desc(spread))

fx_instability %>%
slice_head(n = 50) %>%
gt() %>%
cols_label(
year = "Year",
project_country = "Project country",
n = "Awards (count)",
rate_median = "Median implied rate",
rate_p10 = "P10 implied rate",
rate_p90 = "P90 implied rate",
spread = "P90‚ÄìP10 spread"
) %>%
fmt_number(columns = n, decimals = 0) %>%
fmt_number(columns = c(rate_median, rate_p10, rate_p90, spread), decimals = 4) %>%
tab_header(
title = "Implied Rate Instability (Wide Dispersion)",
subtitle = "Year‚Äìcountry groups with unusually wide implied-rate bands"
)
```

### üß≠ How to Interpret Section 11

- The implied conversion factor is a **consistency check**, not an estimate of true FX rates.
- Stable year‚Äìcountry medians and narrow P10‚ÄìP90 bands suggest coherent conversion practices.
- Extreme outliers or wide spreads are best treated as **data-quality follow-up items**, often caused by currency miscoding, unit/decimal issues, or inconsistent conversion timing.

## Procurement Supply Corridors (Project Country ‚Üí Supplier Nationality)

::: {.callout-note}
### üåç Analytical Focus
This section maps the strongest procurement ‚Äúcorridors‚Äù linking **project countries** to the **nationalities of winning suppliers**.  
These corridors help identify patterns of dependence and specialization‚Äîe.g., whether procurement is primarily domestic, regionally sourced, or concentrated among a small set of external supplier countries.

Corridor results complement concentration and domestic-share metrics by showing **who supplies whom**, not just aggregate shares.
:::

### Core Supply Corridors Table (Top Corridors by Total Spend)

```{r}
library(dplyr)
library(gt)
library(scales)

corridors <- df %>%
filter(!is.na(bidder_nationality), bidder_nationality != "") %>%
group_by(project_country, bidder_nationality) %>%
summarise(
total_spend_usd = sum(spend_usd, na.rm = TRUE),
awards = dplyr::n(),
.groups = "drop"
) %>%
arrange(desc(total_spend_usd))

corridors %>%
slice_head(n = 25) %>%
gt() %>%
cols_label(
project_country = "Project country",
bidder_nationality = "Supplier nationality",
total_spend_usd = "Total spend (USD)",
awards = "Awards (count)"
) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_number(columns = awards, decimals = 0) %>%
tab_header(
title = "Top Procurement Supply Corridors",
subtitle = "Project country ‚Üí supplier nationality, ranked by total spend"
)
```

### Country-Centric Corridor Profile (Top Supplier Nationalities Per Country)

```{r}
country_corridors <- corridors %>%
group_by(project_country) %>%
mutate(share = total_spend_usd / sum(total_spend_usd, na.rm = TRUE)) %>%
arrange(project_country, desc(total_spend_usd))

country_corridors %>%
group_by(project_country) %>%
slice_head(n = 5) %>%
ungroup() %>%
gt(groupname_col = "project_country") %>%
cols_label(
bidder_nationality = "Top supplier nationality",
total_spend_usd = "Total spend (USD)",
awards = "Awards (count)",
share = "Share of country spend"
) %>%
fmt_currency(columns = total_spend_usd, currency = "USD", decimals = 0) %>%
fmt_number(columns = awards, decimals = 0) %>%
fmt_percent(columns = share, decimals = 1) %>%
tab_header(
title = "Top 5 Supplier Nationalities by Project Country",
subtitle = "Country profiles based on corridor concentration"
)
```

### Visualiation - Top Supplier Nationalities per Project Country

```{r}
library(dplyr)
library(ggplot2)
library(scales)
library(tidytext)  # needed for reorder_within() and scale_x_reordered()

# choose how many countries to display

top_n_countries <- 12

# identify top countries by total spend (across all corridors)

top_countries_corr <- corridors %>%
group_by(project_country) %>%
summarise(country_spend = sum(total_spend_usd, na.rm = TRUE), .groups = "drop") %>%
arrange(desc(country_spend)) %>%
slice_head(n = top_n_countries) %>%
pull(project_country)

# keep top 5 supplier nationalities within each selected country

plot_corridors <- corridors %>%
filter(project_country %in% top_countries_corr) %>%
group_by(project_country) %>%
slice_max(order_by = total_spend_usd, n = 5, with_ties = FALSE) %>%
ungroup()

# plot

ggplot(
plot_corridors,
aes(
x = reorder_within(bidder_nationality, total_spend_usd, project_country),
y = total_spend_usd
)
) +
geom_col(fill = "grey40", width = 0.7) +
coord_flip() +
facet_wrap(~ project_country, scales = "free_y") +
scale_y_continuous(
labels = label_dollar(),
breaks = scales::pretty_breaks(n = 3)   # fewer ticks per facet to prevent overlap
) +
scale_x_reordered() +
labs(
title = "Top Supplier Nationalities by Project Country (Top Spend Countries)",
subtitle = paste0(
"Top 5 supplier nationalities per country; showing top ",
top_n_countries, " countries by total spend"
),
x = "Supplier nationality",
y = "Spend (USD)"
) +
theme_minimal(base_size = 11) +
theme(
axis.text.y = element_text(size = 9),
axis.text.x = element_text(angle = 30, hjust = 1),
panel.spacing = grid::unit(1.2, "lines"),
strip.text = element_text(face = "bold")
)
```

### üß≠ How to Read Section 12 (Procurement Supply Corridors)

Section 12 visualizes **procurement supply corridors**, defined as the linkage between a *project country* and the *nationality of winning suppliers*. Each bar represents the total value of contracts awarded to suppliers from a given nationality within a country.

- **Dominant corridors** (large bars relative to others in the same country) indicate strong reliance on a particular supplier nationality. This may reflect legitimate specialization, capacity constraints in domestic markets, or regional integration.
- **Diversified corridors**‚Äîwhere spend is spread across several nationalities‚Äîsuggest broader competition and reduced dependence risk.
- Countries shown here are the **top spenders** in the portfolio; patterns for smaller portfolios may differ and should be interpreted cautiously.

Supply corridors should be interpreted **alongside domestic share and supplier concentration metrics**. A strong external corridor is not inherently problematic, but when combined with **high concentration, repeat awards, or low-competition procurement methods**, it becomes a relevant signal for deeper market and governance review.
